# 微信小程序文件预览400错误解决方案

## 问题背景
微信小程序直接下载Supabase Storage公共URL时返回400错误，这是由于微信小程序与Supabase之间的兼容性问题。

## 解决方案概述
我们采用了"链接复制+浏览器打开"的方案，完全绕开小程序的`downloadFile`限制，无需后端中转。

## 实现原理
1. 用户点击文件预览
2. 系统自动复制Supabase文件链接到剪贴板
3. 弹出引导框，提示用户在浏览器中打开链接
4. 可选择在微信内置浏览器中直接打开

## 核心优势
- **开发成本低**: 纯前端实现，无需后端接口
- **兼容性好**: 100%支持所有文件类型
- **用户体验佳**: 一键复制+引导，操作简单
- **稳定性高**: 不受微信小程序API限制影响

## 实现细节

### 1. 新增页面
- `pages/web-view/web-view`: 微信内置浏览器页面，用于直接打开文件链接

### 2. 修改文件
- `pages/knowledge/index.js`: 添加`openFileInBrowser`方法，替换`previewFile`方法
- `app.json`: 添加web-view页面路由

### 3. 用户操作流程
1. 用户点击"预览"按钮
2. 系统自动复制文件链接到剪贴板
3. 显示"链接已复制"提示
4. 弹出操作指引
5. 用户可选择"打开浏览器"直接跳转，或手动打开浏览器粘贴链接

## 测试步骤
1. 上传一个PDF或DOCX文件
2. 点击"预览"按钮
3. 确认链接已自动复制到剪贴板
4. 点击"打开浏览器"按钮
5. 在微信内置浏览器中查看文件
6. 如果无法查看，可复制链接到系统浏览器中查看

## 注意事项
- 确保Supabase文件的public URL可匿名访问
- 文件链接较长，但不受影响
- 系统浏览器对各种文件类型的支持更全面

## 后续优化建议
1. 可考虑集成短链接服务，缩短复制的链接长度
2. 添加文件预览记录，便于用户快速访问历史文件
3. 针对不同文件类型提供不同的预览建议