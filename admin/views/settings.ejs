<%- include('layout', {title: title, user: user, currentPage: currentPage, body: `
<div class="row">
  <!-- 系统配置 -->
  <div class="col-lg-8">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">系统配置</h6>
      </div>
      <div class="card-body">
        <div id="systemConfig">
          <div class="text-center">
            <span class="spinner-border spinner-border-sm"></span> 加载中...
          </div>
        </div>
      </div>
    </div>

    <!-- 公告管理 -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <div class="row align-items-center">
          <div class="col">
            <h6 class="m-0 font-weight-bold text-primary">公告管理</h6>
          </div>
          <div class="col-auto">
            <button class="btn btn-primary btn-sm" onclick="showAnnouncementModal()">
              <i class="bi bi-plus-circle me-1"></i>发布公告
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- 筛选选项 -->
        <div class="row mb-3">
          <div class="col-md-3">
            <select class="form-select" id="announcementStatus" onchange="loadAnnouncements()">
              <option value="">全部状态</option>
              <option value="active">生效中</option>
              <option value="inactive">已过期</option>
            </select>
          </div>
        </div>

        <!-- 公告列表 -->
        <div class="table-responsive">
          <table class="table table-hover" id="announcementsTable">
            <thead>
              <tr>
                <th>标题</th>
                <th>类型</th>
                <th>优先级</th>
                <th>状态</th>
                <th>创建时间</th>
                <th>过期时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="text-center">
                  <span class="spinner-border spinner-border-sm"></span> 加载中...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 系统状态 -->
  <div class="col-lg-4">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">系统状态</h6>
      </div>
      <div class="card-body">
        <div id="systemHealth">
          <div class="text-center">
            <span class="spinner-border spinner-border-sm"></span> 检查中...
          </div>
        </div>
      </div>
    </div>

    <!-- 操作日志 -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">操作日志</h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm" id="logsTable">
            <thead>
              <tr>
                <th>时间</th>
                <th>用户</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" class="text-center">
                  <span class="spinner-border spinner-border-sm"></span> 加载中...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 公告编辑模态框 -->
<div class="modal fade" id="announcementModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">发布公告</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="announcementForm">
          <div class="mb-3">
            <label for="announcementTitle" class="form-label">公告标题</label>
            <input type="text" class="form-control" id="announcementTitle" required>
          </div>
          
          <div class="mb-3">
            <label for="announcementContent" class="form-label">公告内容</label>
            <textarea class="form-control" id="announcementContent" rows="4" required></textarea>
          </div>
          
          <div class="mb-3">
            <label for="announcementType" class="form-label">公告类型</label>
            <select class="form-select" id="announcementType">
              <option value="general">一般公告</option>
              <option value="maintenance">维护通知</option>
              <option value="feature">功能更新</option>
              <option value="holiday">节假日</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="announcementPriority" class="form-label">优先级</label>
            <select class="form-select" id="announcementPriority">
              <option value="low">低</option>
              <option value="medium" selected>中</option>
              <option value="high">高</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="announcementExpires" class="form-label">过期时间（可选）</label>
            <input type="datetime-local" class="form-control" id="announcementExpires">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="saveAnnouncement()">发布</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentEditingAnnouncement = null;

document.addEventListener('DOMContentLoaded', function() {
  loadSystemConfig();
  loadSystemHealth();
  loadAnnouncements();
  loadOperationLogs();
});

// 加载系统配置
async function loadSystemConfig() {
  try {
    const response = await fetch('/api/settings/config', {
      headers: getAuthHeaders()
    });
    
    const data = await response.json();
    
    if (data.success) {
      displaySystemConfig(data.data);
    }
  } catch (error) {
    console.error('加载系统配置失败:', error);
  }
}

// 显示系统配置
function displaySystemConfig(config) {
  const container = document.getElementById('systemConfig');
  
  container.innerHTML = \`
    <div class="row">
      <div class="col-md-6">
        <h6 class="mb-3">数据库配置</h6>
        <div class="mb-2">
          <strong>主机:</strong> \${config.database.host}
        </div>
        <div class="mb-2">
          <strong>端口:</strong> \${config.database.port}
        </div>
        <div class="mb-2">
          <strong>数据库名:</strong> \${config.database.name}
        </div>
      </div>
      
      <div class="col-md-6">
        <h6 class="mb-3">Supabase配置</h6>
        <div class="mb-2">
          <strong>URL:</strong> 
          <code>\${config.supabase.url.substring(0, 30)}...</code>
        </div>
        <div class="mb-2">
          <strong>Anon Key:</strong> \${config.supabase.hasAnonKey ? '已配置' : '未配置'}
        </div>
        <div class="mb-2">
          <strong>Service Key:</strong> \${config.supabase.hasServiceKey ? '已配置' : '未配置'}
        </div>
      </div>
    </div>
    
    <div class="row mt-4">
      <div class="col-md-6">
        <h6 class="mb-3">AI服务配置</h6>
        <div class="mb-2">
          <strong>Qwen:</strong> 
          <span class="badge bg-\${config.ai.qwen.configured ? 'success' : 'secondary'}">
            \${config.ai.qwen.configured ? '已配置' : '未配置'}
          </span>
        </div>
        <div class="mb-2">
          <strong>DeepSeek:</strong> 
          <span class="badge bg-\${config.ai.deepseek.configured ? 'success' : 'secondary'}">
            \${config.ai.deepseek.configured ? '已配置' : '未配置'}
          </span>
        </div>
        <div class="mb-2">
          <strong>Coze:</strong> 
          <span class="badge bg-\${config.ai.coze.configured ? 'success' : 'secondary'}">
            \${config.ai.coze.configured ? '已配置' : '未配置'}
          </span>
        </div>
      </div>
      
      <div class="col-md-6">
        <h6 class="mb-3">服务器配置</h6>
        <div class="mb-2">
          <strong>端口:</strong> \${config.server.port}
        </div>
        <div class="mb-2">
          <strong>环境:</strong> \${config.server.nodeEnv}
        </div>
        <div class="mb-2">
          <strong>JWT密钥:</strong> \${config.server.jwtSecret ? '已配置' : '未配置'}
        </div>
      </div>
    </div>
  \`;
}

// 加载系统健康状态
async function loadSystemHealth() {
  try {
    const response = await fetch('/api/settings/health', {
      headers: getAuthHeaders()
    });
    
    const data = await response.json();
    
    if (data.success) {
      displaySystemHealth(data.data);
    }
  } catch (error) {
    console.error('加载系统健康状态失败:', error);
  }
}

// 显示系统健康状态
function displaySystemHealth(health) {
  const container = document.getElementById('systemHealth');
  
  container.innerHTML = \`
    <div class="mb-3">
      <h6 class="mb-2">服务器状态</h6>
      <div class="mb-2">
        <small>运行时间:</small> <strong>\${Math.floor(health.server.uptime / 3600)}小时</strong>
      </div>
      <div class="mb-2">
        <small>内存使用:</small> <strong>\${Math.round(health.server.memory.heapUsed / 1024 / 1024)}MB</strong>
      </div>
    </div>
    
    <div class="mb-3">
      <h6 class="mb-2">服务状态</h6>
      <div class="mb-2">
        <small>数据库:</small> 
        <span class="badge bg-success">正常</span>
      </div>
      <div class="mb-2">
        <small>Qwen AI:</small> 
        <span class="badge bg-\${health.services.qwen === 'configured' ? 'success' : 'secondary'}">
          \${health.services.qwen === 'configured' ? '已配置' : '未配置'}
        </span>
      </div>
      <div class="mb-2">
        <small>DeepSeek AI:</small> 
        <span class="badge bg-\${health.services.deepseek === 'configured' ? 'success' : 'secondary'}">
          \${health.services.deepseek === 'configured' ? '已配置' : '未配置'}
        </span>
      </div>
      <div class="mb-2">
        <small>Coze AI:</small> 
        <span class="badge bg-\${health.services.coze === 'configured' ? 'success' : 'secondary'}">
          \${health.services.coze === 'configured' ? '已配置' : '未配置'}
        </span>
      </div>
    </div>
    
    <div class="text-center mt-3">
      <button class="btn btn-sm btn-outline-primary" onclick="refreshHealthStatus()">
        <i class="bi bi-arrow-clockwise me-1"></i>刷新状态
      </button>
    </div>
  \`;
}

// 加载公告列表
async function loadAnnouncements() {
  try {
    const status = document.getElementById('announcementStatus').value;
    const params = status ? \`?status=\${status}\` : '';
    
    const response = await fetch(\`/api/settings/announcements\${params}\`, {
      headers: getAuthHeaders()
    });
    
    const data = await response.json();
    
    if (data.success) {
      displayAnnouncements(data.data.announcements);
    }
  } catch (error) {
    console.error('加载公告列表失败:', error);
  }
}

// 显示公告列表
function displayAnnouncements(announcements) {
  const tbody = document.querySelector('#announcementsTable tbody');
  
  if (announcements.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无公告</td></tr>';
    return;
  }
  
  tbody.innerHTML = announcements.map(announcement => {
    const typeLabels = {
      general: '一般',
      maintenance: '维护',
      feature: '功能',
      holiday: '节假日'
    };
    
    const priorityLabels = {
      low: '低',
      medium: '中',
      high: '高'
    };
    
    const priorityColors = {
      low: 'secondary',
      medium: 'warning',
      high: 'danger'
    };
    
    const isExpired = announcement.expires_at && new Date(announcement.expires_at) < new Date();
    const isActive = announcement.is_active && !isExpired;
    
    return \`
      <tr>
        <td>\${announcement.title}</td>
        <td><span class="badge bg-info">\${typeLabels[announcement.type] || announcement.type}</span></td>
        <td><span class="badge bg-\${priorityColors[announcement.priority]}">\${priorityLabels[announcement.priority]}</span></td>
        <td>
          <span class="badge bg-\${isActive ? 'success' : 'secondary'}">
            \${isActive ? '生效中' : '已过期'}
          </span>
        </td>
        <td>\${formatDate(announcement.created_at)}</td>
        <td>\${announcement.expires_at ? formatDate(announcement.expires_at) : '无'}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="editAnnouncement('\${announcement.id}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger" onclick="deleteAnnouncement('\${announcement.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    \`;
  }).join('');
}

// 显示公告编辑模态框
function showAnnouncementModal(announcement = null) {
  currentEditingAnnouncement = announcement;
  
  if (announcement) {
    document.getElementById('modalTitle').textContent = '编辑公告';
    document.getElementById('announcementTitle').value = announcement.title;
    document.getElementById('announcementContent').value = announcement.content;
    document.getElementById('announcementType').value = announcement.type;
    document.getElementById('announcementPriority').value = announcement.priority;
    document.getElementById('announcementExpires').value = announcement.expires_at ? announcement.expires_at.slice(0, 16) : '';
  } else {
    document.getElementById('modalTitle').textContent = '发布公告';
    document.getElementById('announcementForm').reset();
  }
  
  new bootstrap.Modal(document.getElementById('announcementModal')).show();
}

// 保存公告
async function saveAnnouncement() {
  const title = document.getElementById('announcementTitle').value.trim();
  const content = document.getElementById('announcementContent').value.trim();
  const type = document.getElementById('announcementType').value;
  const priority = document.getElementById('announcementPriority').value;
  const expires_at = document.getElementById('announcementExpires').value;
  
  if (!title || !content) {
    showAlert('标题和内容不能为空', 'warning');
    return;
  }
  
  try {
    const data = { title, content, type, priority, expires_at: expires_at || null };
    const url = currentEditingAnnouncement ? 
      \`/api/settings/announcements/\${currentEditingAnnouncement.id}\` : 
      '/api/settings/announcements';
    const method = currentEditingAnnouncement ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      headers: getAuthHeaders(),
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      showAlert(currentEditingAnnouncement ? '公告更新成功' : '公告发布成功', 'success');
      bootstrap.Modal.getInstance(document.getElementById('announcementModal')).hide();
      loadAnnouncements();
    } else {
      showAlert('操作失败: ' + result.message, 'danger');
    }
  } catch (error) {
    console.error('保存公告失败:', error);
    showAlert('保存公告失败', 'danger');
  }
}

// 编辑公告
function editAnnouncement(id) {
  // 这里应该从服务器获取完整的公告信息
  // 为了演示，我们使用模拟数据
  const mockAnnouncement = {
    id: id,
    title: '测试公告标题',
    content: '测试公告内容',
    type: 'general',
    priority: 'medium',
    expires_at: null
  };
  
  showAnnouncementModal(mockAnnouncement);
}

// 删除公告
function deleteAnnouncement(id) {
  if (confirm('确定要删除这个公告吗？')) {
    fetch(\`/api/settings/announcements/\${id}\`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showAlert('公告删除成功', 'success');
        loadAnnouncements();
      } else {
        showAlert('删除失败: ' + data.message, 'danger');
      }
    })
    .catch(error => {
      console.error('删除公告失败:', error);
      showAlert('删除公告失败', 'danger');
    });
  }
}

// 加载操作日志
async function loadOperationLogs() {
  try {
    const response = await fetch('/api/settings/logs?limit=10', {
      headers: getAuthHeaders()
    });
    
    const data = await response.json();
    
    if (data.success) {
      displayOperationLogs(data.data.logs);
    }
  } catch (error) {
    console.error('加载操作日志失败:', error);
  }
}

// 显示操作日志
function displayOperationLogs(logs) {
  const tbody = document.querySelector('#logsTable tbody');
  
  if (logs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">暂无日志</td></tr>';
    return;
  }
  
  tbody.innerHTML = logs.map(log => \`
    <tr>
      <td><small>\${formatDate(log.created_at)}</small></td>
      <td>\${log.username}</td>
      <td><small>\${log.action}</small></td>
    </tr>
  \`).join('');
}

// 刷新健康状态
function refreshHealthStatus() {
  showAlert('正在检查系统状态...', 'info');
  loadSystemHealth();
}
</script>
`}) %>