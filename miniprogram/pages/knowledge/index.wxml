<view class="knowledge-page">
  <!-- 0. å¼¥æ•£èƒŒæ™¯ -->
  <view class="ambient-container">
    <view class="orb orb-1"></view>
    <view class="orb orb-2"></view>
    <view class="orb orb-3"></view>
    <view class="orb orb-4"></view>
  </view>

  <custom-navbar title="Syllaby" subtitle="çŸ¥è¯†åº“" />

  <!-- é¡¶éƒ¨ç•™ç™½ï¼Œè§£å†³ custom-navbar é®æŒ¡é—®é¢˜ -->
  <view style="height: 80rpx;"></view>

  <scroll-view scroll-y="true" style="height: calc(100vh - 80rpx);" enable-flex="true">
    
    <!-- 1. æ•°æ®æ¦‚è§ˆ (Bento Grid) -->
    <view class="header-section">
      <view class="bento-grid">
        <!-- Continuum: ä¸“è¾‘å°é¢æ„Ÿ -->
        <view class="bento-card main interactable" bindtap="openLastFile">
          <view class="watermark-icon">â–¶</view>
          <view class="card-content-bottom">
            <block wx:if="{{lastOpenedFile}}">
              <view class="mini-tag">{{lastOpenedFile.type || 'FILE'}}</view>
              <text class="hero-filename">{{lastOpenedFile.name}}</text>
            </block>
            <block wx:else>
              <text class="hero-filename placeholder" decode="true">Start\nLearning</text>
            </block>
          </view>
        </view>

        <!-- AI åˆ’é‡ç‚¹å…¥å£ -->
        <view class="bento-card ai-entry-card interactable" bindtap="enterAiMode">
          <view class="ai-glow"></view>
          <view class="ai-entry-body">
            <text class="ai-glyph">âœ¹</text>
            <text class="ai-caption">{{(actionableInsight && actionableInsight.cta) || 'AI åˆ’é‡ç‚¹'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 2. æ–‡ä»¶å¤¹æ¨ªå‘æ»šåŠ¨ (Chips) -->
    <view class="section-title">
      <text>åˆ†ç±»</text>
      <view class="count-badge">{{folders.length}}</view>
      <view class="title-actions" wx:if="{{!selectionMode}}">
        <view class="upload-btn" bindtap="uploadResource">
          <text class="upload-icon">+</text>
          <text class="upload-text">ä¸Šä¼ </text>
        </view>
        <view class="batch-toggle-btn" bindtap="enterSelectionMode">
          <text>â‹®</text>
        </view>
      </view>
    </view>
    
    <scroll-view class="folder-scroll" scroll-x="true" enable-flex="true" show-scrollbar="false">
      <view class="folder-chip {{activeFolder === 'å…¨éƒ¨' ? 'active' : ''}}" 
            bindtap="selectFolder" data-name="å…¨éƒ¨">
        <text>å…¨éƒ¨</text>
      </view>
      
      <block wx:for="{{folders}}" wx:key="id">
        <view class="folder-chip {{activeFolder === item.name ? 'active' : ''}}"
              data-name="{{item.name}}"
              bindtap="selectFolder"
              bindlongpress="handleFolderLongPress">
          <view class="chip-dot" style="background: {{item.tone}};"></view>
          <text>{{item.name}}</text>
          <text class="chip-count">{{item.count}}</text>
        </view>
      </block>
      <!-- å ä½ç¬¦ï¼Œä¿è¯æœ€åä¸€ä¸ªèƒ½æ»‘å‡ºæ¥ -->
      <view style="width: 40rpx; display:inline-block;"></view>
    </scroll-view>

    <!-- AI æ‰«æçŠ¶æ€/ç»“æœ -->
    <view class="ai-panel-wrapper" wx:if="{{aiPolling || aiScanPreview || aiScanError}}">
      <view class="ai-panel loading" wx:if="{{aiPolling}}">
        <view class="panel-header">
          <text class="panel-title">Coze æ­£åœ¨è§£æ</text>
          <text class="panel-subtitle">å¹³å‡ 1-2 ç§’ï¼Œå‹¿ç¦»å¼€é¡µé¢</text>
        </view>
        <view class="panel-progress">
          <view class="pulse"></view>
        </view>
      </view>

      <view class="ai-panel error" wx:elif="{{aiScanError}}">
        <view class="panel-header">
          <text class="panel-title">è§£æå¤±è´¥</text>
          <text class="panel-subtitle">{{aiScanError}}</text>
        </view>
        <view class="panel-actions">
          <view class="panel-btn ghost" bindtap="copyAiScanJson">å¤åˆ¶æ—¥å¿—</view>
        </view>
      </view>

      <view class="ai-panel success" wx:elif="{{aiScanPreview}}">
        <view class="panel-header">
          <view>
            <text class="panel-title">AI è¯†åˆ«å®Œæˆ ({{aiScanPreview.count}})</text>
            <text class="panel-subtitle">ç±»å‹ï¼š{{aiScanPreview.type || 'æœªçŸ¥'}}</text>
          </view>
          <view class="panel-actions">
            <view class="panel-btn primary" bindtap="importAiScanResult">å¯¼å…¥</view>
            <view class="panel-btn ghost" bindtap="copyAiScanJson">å¤åˆ¶ JSON</view>
          </view>
        </view>
        <view class="panel-list">
          <block wx:for="{{aiScanPreview.items}}" wx:key="id">
            <view class="panel-item">
              <view class="panel-item-title">{{item.title}}</view>
              <view class="panel-item-subtitle">{{item.subtitle || 'â€”'}}</view>
            </view>
          </block>
        </view>
      </view>
    </view>

    <!-- 3. æ–‡ä»¶åˆ—è¡¨ -->
    <view class="section-title" style="margin-top: 20rpx;">
      <text>{{activeFolder}}</text>
      <text style="font-size: 24rpx; opacity: 0.4; font-weight: normal; margin-left: auto;">æŒ‰æ—¶é—´æ’åº</text>
    </view>

    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
    <view class="batch-dock" wx:if="{{selectionMode}}">
      <view class="batch-info">
        <text class="batch-count">{{selectedFiles.length}}</text>
        <text class="batch-label">å·²é€‰æ‹©</text>
      </view>
      <view class="batch-actions">
        <view class="batch-btn {{selectedFiles.length !== 1 ? 'disabled' : ''}}" bindtap="batchRename">
          <text class="batch-icon">âœï¸</text>
          <text class="batch-text">é‡å‘½å</text>
        </view>
        <view class="batch-btn" bindtap="batchChangeCategory">
          <text class="batch-icon">ğŸ“</text>
          <text class="batch-text">ç§»åŠ¨</text>
        </view>
        <view class="batch-btn create-btn" bindtap="batchCreateFolder">
          <text class="batch-icon">â•</text>
          <text class="batch-text">æ–°å»ºæ–‡ä»¶å¤¹</text>
        </view>
        <view class="batch-btn close-btn" bindtap="exitSelectionMode">
          <text class="batch-icon">âœ•</text>
          <text class="batch-text">å–æ¶ˆ</text>
        </view>
      </view>
    </view>

    <view class="file-list">
      <block wx:for="{{filteredFiles}}" wx:key="id">
        <view class="file-card {{selectionMode ? 'selection-mode' : ''}} {{item.isSelected ? 'selected' : ''}}"
              data-id="{{item.id}}"
              bindtap="{{selectionMode ? 'toggleFileSelection' : 'previewFile'}}"
              bindlongpress="{{!selectionMode ? 'handleFileLongPress' : ''}}">
          
          <!-- æ–‡ä»¶ç±»å‹å›¾æ ‡ -->
          <view class="file-icon-box icon-box-{{item.uiType || item.type}}">
             {{item.uiType || item.type}}
             <!-- é€‰æ‹©æ¨¡å¼ä¸‹çš„é€‰æ‹©æŒ‡ç¤ºå™¨ -->
             <view wx:if="{{selectionMode}}" class="selection-indicator {{item.isSelected ? 'checked' : ''}}">
               <text wx:if="{{item.isSelected}}" class="selection-check">âœ“</text>
             </view>
          </view>
          
          <!-- æ–‡ä»¶ä¿¡æ¯ -->
          <view class="file-info">
            <view class="file-name">{{item.name}}</view>
            <view class="file-meta-row">
              <view class="meta-tag">{{item.size ? formatSize(item.size) : 'æœªçŸ¥å¤§å°'}}</view>
              
              <!-- AI æ‘˜è¦æ ‡ç­¾ -->
              <view class="meta-tag ai-summary-tag" wx:if="{{item.aiSummary}}">
                 <text>âœ¨ å·²åˆ’é‡ç‚¹</text>
              </view>
            </view>
          </view>
        </view>
      </block>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{!filteredFiles.length}}" style="text-align:center; padding: 100rpx 0; opacity: 0.5;">
        <view style="font-size: 80rpx; margin-bottom: 20rpx;">ğŸŒ«ï¸</view>
        <view>è¿™é‡Œåƒå¤–å¤ªç©ºä¸€æ ·å®‰é™</view>
      </view>
    </view>
  </scroll-view>

  
</view>
