<view class="profile-page">
  <custom-navbar title="Syllaby" subtitle="ä¸ªäººä¸»é¡µ" />

  <scroll-view class="zen-scroll" scroll-y="true" enable-flex="true">
    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <view class="card user-card">
      <view class="user-header">
        <view class="avatar-wrapper">
          <image
            class="avatar"
            src="{{profile.avatar_url || '/static/default-avatar.png'}}"
            mode="aspectFill"
          />
        </view>
        <view class="user-info">
          <view class="nickname">{{profile.nickname}}</view>
          <view class="school-info muted">
            <text wx:if="{{profile.school_name}}">{{profile.school_name}}</text>
            <text wx:if="{{profile.school_name && profile.grade}}"> Â· </text>
            <text wx:if="{{profile.grade}}">{{profile.grade}}</text>
          </view>
          <view class="bio muted" wx:if="{{profile.bio}}">{{profile.bio}}</view>
        </view>
        <view class="edit-btn" wx:if="{{!isGuest}}" bindtap="editProfile">
          <text>ç¼–è¾‘</text>
        </view>
      </view>
    </view>

    <view class="guest-card" wx:if="{{isGuest}}">
      <view class="guest-header">
        <text class="guest-title">å½“å‰ä¸ºæ¸¸å®¢æ¨¡å¼</text>
        <text class="guest-tag">Visitor</text>
      </view>
      <view class="guest-desc">ç™»å½• / æ³¨å†Œåå³å¯åŒæ­¥è¯¾ç¨‹ã€ä»»åŠ¡å’Œä¸“æ³¨è®°å½•ã€‚</view>
      <view class="guest-actions">
        <view class="login-btn" bindtap="goLogin">ç™»å½• Â· æ³¨å†Œ</view>
      </view>
    </view>

    <!-- å­¦ä¹ ç»Ÿè®¡å¡ç‰‡ -->
    <view class="card stats-card">
      <view class="section-head">
        <text>å­¦ä¹ ç»Ÿè®¡</text>
        <text class="muted mono">Learning Stats</text>
      </view>

      <view class="stats-grid">
        <view class="stat-item">
          <view class="stat-value">{{stats.today_focus_minutes}}</view>
          <view class="stat-label muted">ä»Šæ—¥ä¸“æ³¨(åˆ†é’Ÿ)</view>
        </view>
        <view class="stat-item">
          <view class="stat-value">{{stats.week_focus_minutes}}</view>
          <view class="stat-label muted">æœ¬å‘¨ä¸“æ³¨(åˆ†é’Ÿ)</view>
        </view>
        <view class="stat-item">
          <view class="stat-value">{{stats.continuous_days}}</view>
          <view class="stat-label muted">è¿ç»­å­¦ä¹ (å¤©)</view>
        </view>
        <view class="stat-item">
          <view class="stat-value">{{stats.total_sessions}}</view>
          <view class="stat-label muted">ä¸“æ³¨æ¬¡æ•°</view>
        </view>
      </view>

      <view class="divider"></view>

      <view class="stats-row">
        <view class="stats-row-item">
          <view class="row-icon row-icon-courses">
            <view class="row-icon-core"></view>
            <view class="row-icon-spark"></view>
          </view>
          <view class="row-info">
            <text class="row-label muted">è¯¾ç¨‹æ•°</text>
            <text class="row-value">{{stats.total_courses}}</text>
          </view>
        </view>
        <view class="stats-row-item">
          <view class="row-icon row-icon-tasks">
            <view class="row-icon-core"></view>
            <view class="row-icon-spark"></view>
          </view>
          <view class="row-info">
            <text class="row-label muted">å®Œæˆä»»åŠ¡</text>
            <text class="row-value">{{stats.completed_tasks}}/{{stats.total_tasks}}</text>
          </view>
        </view>
        <view class="stats-row-item">
          <view class="row-icon row-icon-resources">
            <view class="row-icon-core"></view>
            <view class="row-icon-spark"></view>
          </view>
          <view class="row-info">
            <text class="row-label muted">å­¦ä¹ èµ„æº</text>
            <text class="row-value">{{stats.total_resources}}</text>
          </view>
        </view>
      </view>

      <view class="total-focus">
        <view class="total-focus-label muted">ç´¯è®¡ä¸“æ³¨æ—¶é•¿</view>
        <view class="total-focus-value">
          <text class="focus-hours">{{stats.total_focus_hours}}</text>
          <text class="focus-unit">å°æ—¶</text>
        </view>
      </view>
    </view>

    <!-- æ‰€æœ‰å¾…åŠå…¥å£ -->
    <view class="card tasks-entry-card">
      <view class="section-head">
        <text>ä»»åŠ¡ç®¡ç†</text>
        <text class="muted mono">Task Management</text>
      </view>
      
      <view class="tasks-entry-content">
        <view class="tasks-stats">
          <view class="task-stat-item">
            <view class="task-stat-value">{{stats.total_tasks}}</view>
            <view class="task-stat-label">æ€»ä»»åŠ¡</view>
          </view>
          <view class="task-stat-item">
            <view class="task-stat-value">{{stats.completed_tasks}}</view>
            <view class="task-stat-label">å·²å®Œæˆ</view>
          </view>
          <view class="task-stat-item">
            <view class="task-stat-value">{{stats.total_tasks - stats.completed_tasks}}</view>
            <view class="task-stat-label">å¾…å®Œæˆ</view>
          </view>
        </view>
        
        <view class="tasks-entry-btn" bindtap="navigateToTasks">
          <view class="btn-icon">
            <view class="btn-icon-shape"></view>
          </view>
          <text class="btn-text">æŸ¥çœ‹æ‰€æœ‰å¾…åŠ</text>
          <view class="btn-arrow">â†’</view>
        </view>
      </view>
    </view>

    

    <!-- å¿«æ·æ“ä½œ -->
    <view class="card actions-card">
      <view class="section-head">
        <text>å¿«æ·æ“ä½œ</text>
        <text class="muted mono">Quick Actions</text>
      </view>

      <view class="actions-grid">
        <block wx:for="{{quickActions}}" wx:key="id">
          <view
            class="action-item"
            data-path="{{item.path}}"
            bindtap="navigateToAction"
          >
            <view class="action-icon action-icon-{{item.iconToken || 'neutral'}}">
              <view class="action-icon-core"></view>
              <view class="action-icon-glow"></view>
            </view>
            <view class="action-name">{{item.name}}</view>
          </view>
        </block>
      </view>
    </view>

    
  </scroll-view>

  <view wx:if="{{editModalVisible}}" class="edit-mask" catchtouchmove="stopTouchMove">
    <view class="edit-sheet">
      <view class="sheet-head">
        <text>ç¼–è¾‘ä¸ªäººä¿¡æ¯</text>
        <text class="muted mono">Profile</text>
      </view>
      <view class="sheet-field">
        <text class="label">æ˜µç§°</text>
        <input class="input" value="{{editForm.nickname}}" data-field="nickname" bindinput="onEditInput" placeholder="è¯·è¾“å…¥æ˜µç§°" />
      </view>
      <view class="sheet-field">
        <text class="label">å­¦æ ¡</text>
        <input class="input" value="{{editForm.school_name}}" data-field="school_name" bindinput="onEditInput" placeholder="å­¦æ ¡åç§°" />
      </view>
      <view class="sheet-field">
        <text class="label">å¹´çº§</text>
        <picker
          mode="selector"
          range="{{gradeOptions}}"
          value="{{gradePickerIndex}}"
          bindchange="onGradePickerChange"
        >
          <view class="picker-display {{editForm.grade ? '' : 'placeholder'}}">
            <text>{{editForm.grade || 'è¯·é€‰æ‹©å¹´çº§ï¼ˆå¯æš‚ä¸å¡«å†™ï¼‰'}}</text>
            <text class="picker-arrow">âŒ„</text>
          </view>
        </picker>
      </view>
      <view class="sheet-field">
        <text class="label">å¤´åƒ</text>
        <view class="avatar-upload">
          <image class="avatar-preview" src="{{editForm.avatar_url || '/static/default-avatar.png'}}" mode="aspectFill" />
          <view class="avatar-actions">
            <view class="upload-btn" bindtap="chooseAvatar">
              <text class="upload-icon">ğŸ“·</text>
              <text class="upload-text">æ›´æ¢å¤´åƒ</text>
            </view>
            <view class="reset-btn" wx:if="{{editForm.avatar_url}}" bindtap="resetAvatar">
              <text class="reset-icon">ğŸ”„</text>
              <text class="reset-text">ä½¿ç”¨é»˜è®¤</text>
            </view>
          </view>
        </view>
      </view>
      <view class="sheet-field">
        <text class="label">ä¸ªæ€§ç­¾å</text>
        <textarea class="textarea" value="{{editForm.bio}}" data-field="bio" bindinput="onEditInput" placeholder="å†™ç‚¹è‡ªæˆ‘ä»‹ç»å§" maxlength="60"></textarea>
      </view>
      <button class="primary-btn" loading="{{savingProfile}}" bindtap="saveProfile">ä¿å­˜</button>
      <button class="ghost-btn" disabled="{{savingProfile}}" bindtap="closeEditModal">å–æ¶ˆ</button>
    </view>
  </view>
</view>
