<!--pages/schedule-tasks/index.wxml-->
<view class="tasks-page">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="header-controls">
    <!-- è§†å›¾åˆ‡æ¢å™¨ -->
    <view class="view-switch">
      <view class="switch-pill {{viewMode === 'day' ? 'active' : ''}}" bindtap="switchView" data-mode="day">æ—¥</view>
      <view class="switch-pill {{viewMode === 'week' ? 'active' : ''}}" bindtap="switchView" data-mode="week">å‘¨</view>
      <view class="switch-pill {{viewMode === 'month' ? 'active' : ''}}" bindtap="switchView" data-mode="month">æœˆ</view>
    </view>

    <!-- æ—¥æœŸå¯¼èˆª -->
    <view class="date-nav" wx:if="{{viewMode !== 'nothing'}}">
      <view class="nav-btn" bindtap="changeDate" data-direction="-1">
        <text class="arrow">â€¹</text>
      </view>
      <text class="date-display">{{currentDateText}}</text>
      <view class="nav-btn" bindtap="changeDate" data-direction="1">
        <text class="arrow">â€º</text>
      </view>
    </view>

    <!-- æ·»åŠ è¯¾ç¨‹æŒ‰é’® -->
    <view class="add-course-btn" bindtap="openCreateCourse">
      <text class="add-course-icon">ï¼‹</text>
      <text class="add-course-text">è¯¾ç¨‹</text>
    </view>
  </view>

  <scroll-view class="zen-scroll" scroll-y="true" enable-flex>
    
    <!-- === æ—¥è§†å›¾ (Day) === -->
    <view wx:if="{{viewMode === 'day'}}" class="view-container day-view fade-in">
      <!-- ä»Šæ—¥è¯¾ç¨‹ -->
      <view class="section-head">
        <text class="head-title">ä»Šæ—¥è¯¾ç¨‹</text>
        <text class="head-sub">{{todayCourses.length}} èŠ‚</text>
      </view>
      
      <view class="course-timeline">
        <block wx:for="{{todayCourses}}" wx:key="id">
          <view class="timeline-item">
            <view class="time-col">
              <text class="start-time">{{item.time.split('-')[0]}}</text>
              <view class="time-dot" style="background: {{item.color}}"></view>
            </view>
            <view class="course-card glass-card" style="border-left: 8rpx solid {{item.color}}">
              <text class="card-title">{{item.name}}</text>
              <text class="card-sub">{{item.location}}</text>
            </view>
          </view>
        </block>
        <view wx:if="{{todayCourses.length === 0}}" class="empty-tip">
          <text>ä»Šå¤©æ²¡æœ‰è¯¾ï¼Œå»å›¾ä¹¦é¦†å­¦ä¹ å§</text>
        </view>
      </view>

      <!-- ä»Šæ—¥å¾…åŠ -->
      <view class="section-head mt-40">
        <text class="head-title">ä»Šæ—¥å¾…åŠ</text>
        <view class="add-btn-mini" bindtap="openCreate">ï¼‹</view>
      </view>

      <view class="task-stack">
        <block wx:for="{{todayTasks}}" wx:key="id">
          <view class="task-row glass-card {{item.completed ? 'done' : ''}}" bindtap="openEdit" data-id="{{item.id}}">
            <view class="check-circle {{item.completed ? 'checked' : ''}}" catchtap="markDone" data-id="{{item.id}}"></view>
            <view class="task-info">
              <text class="task-text">{{item.title}}</text>
              <text class="task-meta" style="color: {{item.accent}}">{{item.course}} Â· {{item.deadlineMeta}}</text>
            </view>
          </view>
        </block>
        <view wx:if="{{todayTasks.length === 0}}" class="empty-tip">
          <text>ä»Šæ—¥ä»»åŠ¡å·²æ¸…ç©º</text>
        </view>
      </view>
    </view>

    <!-- === å‘¨è§†å›¾ (Week) === -->
    <view wx:if="{{viewMode === 'week'}}" class="view-container week-view fade-in">
      <!-- ç®€æ˜“è¯¾è¡¨ç½‘æ ¼ -->
      <view class="week-grid-container">
        <view class="week-header-row">
          <view class="corner-box"></view>
          <block wx:for="{{weekDays}}" wx:key="fullDate">
            <view class="day-col-head {{item.isToday ? 'today-head' : ''}}">
              <text class="day-name">{{item.name}}</text>
              <text class="day-num">{{item.date}}</text>
            </view>
          </block>
        </view>

        <view class="week-body">
          <!-- ä¾§è¾¹æ—¶é—´è½´ -->
          <view class="time-sidebar">
            <block wx:for="{{[1,2,3,4,5,6,7,8,9,10,11,12]}}" wx:key="*this">
              <view class="sidebar-slot">{{item}}</view>
            </block>
          </view>
          
          <!-- è¯¾ç¨‹æ¸²æŸ“åŒº -->
          <view class="course-matrix">
             <block wx:for="{{weekDays}}" wx:key="fullDate" wx:for-item="day" wx:for-index="dIdx">
                <!-- æ¯ä¸€åˆ— -->
                <view class="day-column-bg"></view>
             </block>
             
             <!-- ç»å¯¹å®šä½æ¸²æŸ“è¯¾ç¨‹ (éå† slot æ•°æ®) -->
             <block wx:for="{{timeSlots}}" wx:key="time" wx:for-item="slot">
                <block wx:for="{{slot.courses}}" wx:key="id" wx:for-item="course">
                  <!-- è®¡ç®—ä½ç½®: left = (day-1)*100/7 %, top = (start-1)*itemHeight -->
                  <view class="grid-course-item" 
                        style="left: {{(course.day - 1) * 14.28}}%; top: {{(course.start - 1) * 100}}rpx; height: {{course.len * 100}}rpx; background: {{course.color}};"
                        bindtap="openCourse" data-id="{{course.id}}">
                    <text class="grid-text">{{course.name}}</text>
                    <text class="grid-loc">{{course.location}}</text>
                  </view>
                </block>
             </block>
          </view>
        </view>
      </view>

      <!-- æœ¬å‘¨å¾…åŠ - é‡æ–°è®¾è®¡å¢å¼ºå­˜åœ¨æ„Ÿ -->
      <view class="week-tasks-enhanced">
        <!-- å¼¥æ•£èƒŒæ™¯è£…é¥° -->
        <view class="tasks-background-decoration">
          <view class="blob blob-1"></view>
          <view class="blob blob-2"></view>
          <view class="blob blob-3"></view>
        </view>
        
        <!-- å¾…åŠæ ‡é¢˜åŒº - è¶…çº§æ¤­åœ†è®¾è®¡ -->
        <view class="tasks-title-section">
          <view class="title-visual-element">
            <view class="breathing-dot"></view>
            <text class="big-title">æœ¬å‘¨å¾…åŠ</text>
            <view class="title-underline"></view>
          </view>
          
          <view class="stats-row">
            <view class="stat-item">
              <text class="stat-number">{{totalWeekTasks}}</text>
              <text class="stat-label">é¡¹ä»»åŠ¡</text>
            </view>
            <view class="progress-circle-container">
              <view class="progress-circle" style="background: conic-gradient(#87A8A4 0deg, #87A8A4 {{completionRate * 3.6}}deg, rgba(45, 52, 54, 0.1) {{completionRate * 3.6}}deg)">
                <view class="circle-center">
                  <text class="percentage-text">{{completionRate}}%</text>
                </view>
              </view>
              <text class="progress-label">å®Œæˆ</text>
            </view>
          </view>
        </view>

        <!-- å¾…åŠå†…å®¹åŒº - æµåŠ¨å¡ç‰‡è®¾è®¡ -->
        <view class="tasks-content-area">
          <block wx:for="{{weekTasksByDay}}" wx:key="dateKey" wx:for-item="day">
            <view class="day-flow-container {{day.isToday ? 'today-highlight' : ''}}" wx:if="{{day.tasks.length > 0}}">
              <!-- æ—¥æœŸæŒ‡ç¤ºå™¨ -->
              <view class="date-indicator">
                <view class="date-circle {{day.isToday ? 'today' : ''}}">
                  <text class="date-text">{{day.date}}</text>
                </view>
                <text class="date-label">{{day.label}}</text>
                <view class="task-count-bubble">{{day.tasks.length}}</view>
              </view>
              
              <!-- ä»»åŠ¡æµ -->
              <view class="task-flow">
                <block wx:for="{{day.tasks}}" wx:key="id" wx:for-item="task">
                  <view class="task-flow-item {{task.completed ? 'completed-flow' : ''}}" 
                        bindtap="openEdit" data-id="{{task.id}}">
                    <!-- è¿æ¥çº¿ -->
                    <view class="flow-line"></view>
                    
                    <!-- ä»»åŠ¡èŠ‚ç‚¹ -->
                    <view class="task-node">
                      <view class="node-core {{task.completed ? 'completed-node' : task.urgent ? 'urgent-node' : ''}}">
                        <view class="node-inner"></view>
                      </view>
                      
                      <!-- ä»»åŠ¡å¡ç‰‡ -->
                      <view class="task-bubble {{task.type}}">
                        <view class="bubble-content">
                          <text class="bubble-title">{{task.title}}</text>
                          <text class="bubble-subtitle">{{task.course}} Â· {{task.time}}</text>
                        </view>
                        <view class="bubble-type-indicator">
                          <text class="type-text">{{task.type === 'exam' ? 'è€ƒ' : 'ä¸š'}}</text>
                        </view>
                      </view>
                    </view>
                  </view>
                </block>
              </view>
            </view>
          </block>
          
          <!-- ç©ºçŠ¶æ€ - é‡æ–°è®¾è®¡ -->
          <view wx:if="{{totalWeekTasks === 0}}" class="zen-empty-state">
            <view class="empty-illustration">
              <view class="zen-circle"></view>
              <view class="zen-text">ğŸ“‹</view>
            </view>
            <text class="empty-main-text">æœ¬å‘¨æ— å¾…åŠäº‹é¡¹</text>
            <text class="empty-sub-text">æ·»åŠ ä»»åŠ¡å¼€å§‹è§„åˆ’æœ¬å‘¨å­¦ä¹ </text>
            <view class="zen-cta-button" bindtap="openCreate">
              <text class="cta-text">åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡</text>
              <view class="cta-glow"></view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- === æœˆè§†å›¾ (Month / Dashboard) === -->
    <view wx:if="{{viewMode === 'month'}}" class="view-container month-view fade-in">
      
      <!-- 1. æœˆåº¦ç»Ÿè®¡å¡ç‰‡ -->
      <view class="stats-grid">
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthStats.totalTasks}}</text>
          <text class="stat-label">æ€»å¾…åŠ</text>
        </view>
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthStats.completedTasks}}</text>
          <text class="stat-label">å·²å®Œæˆ</text>
        </view>
        <view class="stat-card glass-card highlight">
          <text class="stat-num">{{monthStats.exams}}</text>
          <text class="stat-label">è€ƒè¯•</text>
        </view>
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthStats.busiestDay}}</text>
          <text class="stat-label">æœ€å¿™ç¢Œ</text>
        </view>
      </view>

      <!-- 2. ä»»åŠ¡çƒ­åŠ›å›¾ -->
      <view class="section-head mt-40">
        <text class="head-title">èƒ½é‡åˆ†å¸ƒ</text>
        <text class="head-sub">æœ¬æœˆä»»åŠ¡å¯†åº¦</text>
      </view>
      <view class="heatmap-container glass-card">
        <view class="heatmap-grid">
          <block wx:for="{{monthHeatmap}}" wx:key="day">
            <view class="heat-cell {{item.level}}">
              <text wx:if="{{item.count > 0}}" class="heat-num">{{item.day}}</text>
            </view>
          </block>
        </view>
        <view class="heatmap-legend">
          <text>Less</text>
          <view class="legend-dots">
            <view class="dot l0"></view>
            <view class="dot l1"></view>
            <view class="dot l2"></view>
            <view class="dot l3"></view>
          </view>
          <text>More</text>
        </view>
      </view>

      <!-- 3. è¿‘æœŸé‡è¦æ—¥ç¨‹ -->
      <view class="section-head mt-40">
        <text class="head-title">å³å°†åˆ°æ¥</text>
        <view class="add-btn-mini" bindtap="openCreate">ï¼‹</view>
      </view>
      <view class="upcoming-list">
        <block wx:for="{{upcomingTasks}}" wx:key="id">
          <view class="upcoming-item glass-card" bindtap="openEdit" data-id="{{item.id}}">
            <view class="up-date">
              <text class="up-day">{{item.deadline.split('.')[1]}}</text>
              <text class="up-mon">{{item.deadline.split('.')[0]}}æœˆ</text>
            </view>
            <view class="up-info">
              <text class="up-title">{{item.title}}</text>
              <text class="up-sub {{item.urgent ? 'urgent-text' : ''}}">{{item.course}}</text>
            </view>
            <view class="up-tag" style="background: {{item.accent}}"></view>
          </view>
        </block>
        <view wx:if="{{upcomingTasks.length === 0}}" class="empty-tip">æœªæ¥7å¤©æš‚æ— æ€¥è¿«ä»»åŠ¡</view>
      </view>

    </view>

    <view class="spacer-bottom"></view>
  </scroll-view>

  <!-- ç¼–è¾‘å¼¹çª— -->
  <view wx:if="{{editorVisible}}" class="editor-mask fade-in" bindtap="closeEditor">
    <view class="editor-sheet" catchtap="noop">
      <view class="sheet-header">
        <text class="sheet-title">{{editingTask ? 'ç¼–è¾‘äº‹é¡¹' : 'æ–°å»ºäº‹é¡¹'}}</text>
        <view class="type-toggles">
          <view class="type-btn {{form.type === 'homework' ? 'active' : ''}}" catchtap="changeType" data-type="homework">ä½œä¸š</view>
          <view class="type-btn {{form.type === 'exam' ? 'active' : ''}}" catchtap="changeType" data-type="exam">è€ƒè¯•</view>
        </view>
      </view>
      
      <view class="form-body">
        <input class="zen-input" placeholder="è¦åšä»€ä¹ˆï¼Ÿ" value="{{form.title}}" bindinput="onTitleChange" />
        
        <view class="date-row">
          <picker mode="date" value="{{form.date}}" bindchange="onDateChange">
            <view class="picker-chip">{{form.date || 'æ—¥æœŸ'}}</view>
          </picker>
          <picker mode="time" value="{{form.time}}" bindchange="onTimeChange">
            <view class="picker-chip">{{form.time || 'æ—¶é—´'}}</view>
          </picker>
        </view>

        <textarea class="zen-textarea" placeholder="å¤‡æ³¨ä¿¡æ¯..." value="{{form.description}}" bindinput="onDescChange" />
      </view>

      <view class="sheet-actions">
        <view class="del-btn" wx:if="{{editingTask}}" catchtap="deleteCurrent">åˆ é™¤</view>
        <view class="save-btn" catchtap="submitTask">ä¿å­˜</view>
      </view>
    </view>
  </view>

  <!-- è¯¾ç¨‹ç¼–è¾‘å™¨å¼¹çª— -->
  <view wx:if="{{courseEditorVisible}}" class="editor-mask fade-in" bindtap="closeCourseEditor">
    <view class="editor-sheet" catchtap="noop">
      <view class="sheet-header">
        <text class="sheet-title">{{editingCourse ? 'ç¼–è¾‘è¯¾ç¨‹' : 'æ–°å»ºè¯¾ç¨‹'}}</text>
        <view class="color-picker">
          <block wx:for="{{['#87A8A4', '#BCA0BC', '#E2C2A4', '#E08E79', '#9BB5CE', '#C9A5A0']}}" wx:key="*this">
            <view class="color-option {{courseForm.color === item ? 'selected' : ''}}" 
                  style="background: {{item}}" 
                  catchtap="selectCourseColor" 
                  data-color="{{item}}"></view>
          </block>
        </view>
      </view>
      
      <view class="form-body">
        <input class="zen-input" placeholder="è¯¾ç¨‹åç§°*" value="{{courseForm.name}}" bindinput="onCourseNameChange" />
        <input class="zen-input" placeholder="æˆè¯¾è€å¸ˆ" value="{{courseForm.teacher}}" bindinput="onCourseTeacherChange" />
        <input class="zen-input" placeholder="ä¸Šè¯¾åœ°ç‚¹" value="{{courseForm.location}}" bindinput="onCourseLocationChange" />
        <input class="zen-input" placeholder="å­¦åˆ†" type="digit" value="{{courseForm.credits}}" bindinput="onCourseCreditsChange" />
      </view>

      <view class="sheet-actions">
        <view class="del-btn" wx:if="{{editingCourse}}" catchtap="deleteCourse">åˆ é™¤è¯¾ç¨‹</view>
        <view class="save-btn" catchtap="saveCourse">ä¿å­˜è¯¾ç¨‹</view>
      </view>
    </view>
  </view>
</view>
