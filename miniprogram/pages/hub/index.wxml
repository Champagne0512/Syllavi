<view class="hub-page">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <custom-navbar title="Syllaby" subtitle="æ—¥ç¨‹ç®¡ç†">
    <view slot="right" class="profile-avatar" bindtap="goToProfile">
      <image wx:if="{{profile.avatar_url}}" src="{{profile.avatar_url}}" class="avatar-img"></image>
      <view wx:else class="avatar-placeholder">ğŸ‘¤</view>
    </view>
  </custom-navbar>

  <!-- è§†å›¾åˆ‡æ¢å™¨ & æ—¥æœŸæ§åˆ¶ -->
  <view class="header-controls">
    <view class="view-switch">
      <view class="chip {{viewMode === 'day' ? 'chip-active' : ''}}" bindtap="switchView" data-mode="day">æ—¥</view>
      <view class="chip {{viewMode === 'week' ? 'chip-active' : ''}}" bindtap="switchView" data-mode="week">å‘¨</view>
      <view class="chip {{viewMode === 'month' ? 'chip-active' : ''}}" bindtap="switchView" data-mode="month">æœˆ</view>
    </view>

    <view class="date-nav glass" wx:if="{{viewMode !== 'nothing'}}">
      <view class="nav-btn" bindtap="changeDate" data-direction="-1">
        <text class="arrow">â€¹</text>
      </view>
      <text class="date-display">{{currentDateText}}</text>
      <view class="nav-btn" bindtap="changeDate" data-direction="1">
        <text class="arrow">â€º</text>
      </view>
    </view>
  </view>

  <scroll-view class="zen-scroll" scroll-y="true" enable-flex>
    <view class="ai-panel-wrapper" wx:if="{{aiPolling || aiScanPreview || aiScanError}}">
      <view class="ai-panel loading" wx:if="{{aiPolling}}">
        <view class="panel-header">
          <text class="panel-title">AI æ­£åœ¨è§£æ</text>
          <text class="panel-subtitle">è¯·ç¨å€™ï¼Œå¹³å‡ 1-2 ç§’</text>
        </view>
        <view class="panel-progress">
          <view class="pulse"></view>
        </view>
      </view>

      <view class="ai-panel error" wx:elif="{{aiScanError}}">
        <view class="panel-header">
          <text class="panel-title">è§£æå¤±è´¥</text>
          <text class="panel-subtitle">{{aiScanError}}</text>
        </view>
        <view class="panel-actions">
          <view class="panel-btn ghost" bindtap="copyAiScanJson">å¤åˆ¶æ—¥å¿—</view>
        </view>
      </view>

      <view class="ai-panel success" wx:elif="{{aiScanPreview}}">
        <view class="panel-header">
          <view>
            <text class="panel-title">AI è¯†åˆ«å®Œæˆ ({{aiScanPreview.count}})</text>
            <text class="panel-subtitle">ç±»å‹ï¼š{{aiScanPreview.type || 'æœªçŸ¥'}} </text>
          </view>
          <view class="panel-actions">
            <view class="panel-btn primary" bindtap="importAiScanResult">å¯¼å…¥</view>
            <view class="panel-btn ghost" bindtap="copyAiScanJson">å¤åˆ¶ JSON</view>
          </view>
        </view>
        <view class="panel-list">
          <block wx:for="{{aiScanPreview.items}}" wx:key="id">
            <view class="panel-item">
              <view class="panel-item-title">{{item.title}}</view>
              <view class="panel-item-subtitle">{{item.subtitle || 'â€”'}} </view>
            </view>
          </block>
        </view>
      </view>
    </view>
    
    <!-- === æ—¥è§†å›¾ (Day) === -->
    <view wx:if="{{viewMode === 'day'}}" class="view-container day-view fade-in">
      <!-- ä»Šæ—¥è¯¾ç¨‹ -->
      <view class="section-head">
        <text class="head-title">ä»Šæ—¥è¯¾ç¨‹</text>
        <text class="head-sub">{{todayCourses.length}} èŠ‚</text>
      </view>
      
      <view class="course-timeline">
        <block wx:for="{{todayCourses}}" wx:key="id">
          <view class="timeline-item">
            <view class="time-col">
              <text class="start-time">{{item.time.split('-')[0]}}</text>
              <view class="time-dot" style="background: {{item.color}}"></view>
            </view>
            <view class="course-card glass-card" style="border-left: 8rpx solid {{item.color}}">
              <text class="card-title">{{item.name}}</text>
              <view class="card-meta">
                <text class="card-time">{{item.time}}</text>
                <text class="card-location">{{item.location}}</text>
              </view>
            </view>
          </view>
        </block>
        <view wx:if="{{todayCourses.length === 0}}" class="empty-tip">
          <text>ä»Šå¤©æ²¡æœ‰è¯¾ï¼Œå»å›¾ä¹¦é¦†å­¦ä¹ å§</text>
        </view>
      </view>

      <!-- ä»Šæ—¥å¾…åŠ -->
      <view class="section-head mt-40">
        <text class="head-title">ä»Šæ—¥å¾…åŠ</text>
        <view class="head-actions">
          <view class="complete-btn-mini" wx:if="{{todayTasks.length > 0}}" bindtap="completeAllTasks">å…¨éƒ¨å®Œæˆï¼</view>
          <view class="add-btn-mini" bindtap="openTaskCreator">ï¼‹</view>
        </view>
        <view class="head-sub">{{todayTasks.length}} é¡¹</view>
      </view>

      <view class="task-stack">
        <block wx:for="{{todayTasks}}" wx:key="instanceId">
          <view class="task-row glass-card {{item.completed ? 'done' : ''}}" bindtap="openTaskEditor" data-task="{{item}}">
            <view class="task-check" catchtap="toggleTaskComplete" data-id="{{item.id}}" data-completed="{{item.completed}}">
              <view class="check-circle {{item.completed ? 'checked' : ''}}"></view>
            </view>
            <view class="task-body">
              <view class="task-headline">
                <view class="task-chip {{item.mode === 'instant' ? 'chip-event' : (item.type === 'group_task' ? 'chip-group' : 'chip-homework')}}">{{item.dayBadge || 'æŒç»­å¾…åŠ'}}</view>
                <text class="task-text">{{item.displayTitle || item.title}}</text>
              </view>
              <view class="task-meta-row">
                <text class="task-time">{{item.dayIndicator || item.deadline}}</text>
                <text class="task-course">{{item.courseName || item.course}}</text>
              </view>
              <view class="task-source-tag" wx:if="{{item.groupInfo || item.type === 'group_task'}}">
                <image class="group-avatar-small" src="/static/icons/group-empty.svg" binderror="handleAvatarError"></image>
                <text class="group-name-small">{{item.groupInfo.groupName || 'å­¦ä¹ å°ç»„'}}</text>
                <text class="from-text">æ¥è‡ªå°ç»„ä»»åŠ¡</text>
              </view>
            </view>
          </view>
        </block>
        <view wx:if="{{todayTasks.length === 0}}" class="empty-tip">
          <text>ä»Šæ—¥ä»»åŠ¡å·²æ¸…ç©º</text>
        </view>
      </view>
    </view>

    <!-- === å‘¨è§†å›¾ (Week) === -->
  <view wx:if="{{viewMode === 'week'}}" class="view-container week-view fade-in">
      <!-- è¯¾ç¨‹ç®¡ç†æ ‡é¢˜ -->
      <view class="week-header-actions">
        <view class="section-title-group">
          <text class="head-title">è¯¾ç¨‹è¡¨</text>
          <text class="head-sub">{{totalWeekCourses || 5}} é—¨è¯¾ç¨‹</text>
        </view>
        <view class="add-course-btn" bindtap="addCourse">
          <text class="add-icon">ï¼‹</text>
          <text class="add-text">æ·»åŠ è¯¾ç¨‹</text>
        </view>
      </view>

      <!-- ç®€æ˜“è¯¾è¡¨ç½‘æ ¼ -->
      <view class="week-grid-container">
        <view class="week-header-row">
          <view class="corner-box"></view>
          <block wx:for="{{weekDays}}" wx:key="fullDate">
            <view class="day-col-head {{item.isToday ? 'today-head' : ''}} {{selectedDay === item.dateKey ? 'selected-head' : ''}}" 
                  bindtap="selectDay" data-date="{{item.dateKey}}">
              <text class="day-name">å‘¨{{item.name}}</text>
              <text class="day-num">{{item.date}}</text>
              <view class="day-indicator {{item.isToday ? 'today-indicator' : ''}} {{selectedDay === item.dateKey ? 'selected-indicator' : ''}}"></view>
            </view>
          </block>
        </view>

        <view class="week-body">
          <!-- ä¾§è¾¹æ—¶é—´è½´ -->
          <view class="time-sidebar">
            <block wx:for="{{[1,2,3,4,5,6,7,8,9,10,11,12]}}" wx:key="*this">
              <view class="sidebar-slot">{{item}}</view>
            </block>
          </view>
          
          <!-- è¯¾ç¨‹æ¸²æŸ“åŒº -->
          <view class="course-matrix">
             <block wx:for="{{weekDays}}" wx:key="fullDate" wx:for-item="day" wx:for-index="dIdx">
                <!-- æ¯ä¸€åˆ— -->
                <view class="day-column-bg"></view>
             </block>
             
             <!-- ç»å¯¹å®šä½æ¸²æŸ“è¯¾ç¨‹ (éå† slot æ•°æ®) -->
             <block wx:for="{{timeSlots}}" wx:key="time" wx:for-item="slot">
                <block wx:for="{{slot.courses}}" wx:key="id" wx:for-item="course">
                  <!-- è®¡ç®—ä½ç½®: left = (day-1)*100/7 %, top = (start-1)*itemHeight -->
                  <view class="grid-course-item" 
                        style="left: {{(course.day - 1) * 14.28}}%; top: {{(course.start - 1) * 100}}rpx; height: {{course.len * 100}}rpx; background: {{course.color}};"
                        bindtap="openCourse" data-id="{{course.id}}">
                    <text class="grid-text">{{course.name}}</text>
                    <text class="grid-loc">{{course.location}}</text>
                  </view>
                </block>
             </block>
          </view>
        </view>
      </view>

      <!-- é€‰ä¸­æ—¥æœŸçš„è¯¾ç¨‹è¯¦æƒ… -->
      <view wx:if="{{selectedDay}}" class="selected-day-section glass-card fade-in">
        <view class="selected-day-header">
          <text class="selected-day-title">
            {{selectedDayCourses.length > 0 ? 'ğŸ“š ' : 'ğŸ’¤ '}}
            {{selectedDayText}}çš„è¯¾ç¨‹
          </text>
          <text class="selected-day-count">{{selectedDayCourses.length}} èŠ‚è¯¾</text>
        </view>
        
        <view class="selected-day-courses">
          <block wx:for="{{selectedDayCourses}}" wx:key="id">
            <view class="selected-course-card" style="border-left-color: {{item.color}};">
              <view class="course-time-badge">{{item.time}}</view>
              <text class="course-name">{{item.name}}</text>
              <text class="course-location">{{item.location}}</text>
            </view>
          </block>
          <view wx:if="{{selectedDayCourses.length === 0}}" class="no-courses-tip">
            <text>è¿™ä¸€å¤©æ²¡æœ‰è¯¾ç¨‹å®‰æ’</text>
            <text class="tip-sub">å¯ä»¥å¥½å¥½ä¼‘æ¯æˆ–å®‰æ’è‡ªä¹ </text>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨ï¼šæœ¬å‘¨ä»»åŠ¡æ²³æµ -->
      <view class="section-head mt-40">
        <text class="head-title">æœ¬å‘¨ä»»åŠ¡æ²³æµ</text>
        <text class="head-sub">{{totalWeekTasks}} é¡¹</text>
      </view>
      <view class="week-tasks-enhanced">
        <!-- å¼¥æ•£èƒŒæ™¯è£…é¥° -->
        <view class="tasks-background-decoration">
          <view class="blob blob-1"></view>
          <view class="blob blob-2"></view>
          <view class="blob blob-3"></view>
        </view>
        
        <!-- ä»»åŠ¡æ²³æµæ ‡é¢˜ -->
        <view class="river-title-section">
          <view class="title-visual-element">
            <view class="breathing-dot"></view>
            <text class="river-title">æœ¬å‘¨ä»»åŠ¡æµ</text>
            <view class="title-underline"></view>
          </view>
          
          <view class="river-stats-row">
            <view class="river-stat-item">
              <text class="river-stat-number">{{totalWeekTasks}}</text>
              <text class="river-stat-label">é¡¹ä»»åŠ¡</text>
            </view>
          </view>
        </view>

        <!-- ä»»åŠ¡æ²³æµå†…å®¹ -->
        <view class="river-content-area">
          <block wx:for="{{weekTasksByDay}}" wx:key="dateKey" wx:for-item="day">
            <view class="river-day-container {{day.isToday ? 'today-highlight' : ''}}" wx:if="{{day.tasks && day.tasks.length > 0}}">
              <!-- æ—¥æœŸæŒ‡ç¤ºå™¨ -->
              <view class="river-date-indicator">
                <view class="river-date-circle {{day.isToday ? 'today' : ''}}">
                  <text class="river-date-text">{{day.date}}</text>
                </view>
                <text class="river-date-label">å‘¨{{day.label}}</text>
                <view class="river-task-count">{{day.tasks.length}}</view>
              </view>
              
              <!-- ä»»åŠ¡æµ -->
              <view class="river-task-flow">
                <block wx:for="{{day.tasks}}" wx:key="instanceId" wx:for-item="task">
                  <view class="river-task-item {{task.completed ? 'completed-flow' : ''}}" 
                        data-task="{{task.payload}}" bindtap="openTaskEditor">
                    <!-- è¿æ¥çº¿ -->
                    <view class="river-flow-line"></view>
                    
                    <!-- ä»»åŠ¡èŠ‚ç‚¹ -->
                    <view class="river-task-node">
                      <view class="river-node-core {{task.mode === 'instant' ? 'urgent-node' : ''}}">
                        <view class="river-node-inner"></view>
                      </view>
                      
                      <!-- ä»»åŠ¡å¡ç‰‡ -->
                      <view class="river-task-bubble {{task.mode === 'instant' ? 'exam' : ''}}">
                        <view class="river-bubble-content">
                          <text class="river-bubble-title">{{task.title}}</text>
                          <text class="river-bubble-subtitle">{{task.timelineLabel}}</text>
                        </view>
                        <view class="river-bubble-type-indicator">
                          <text class="river-type-text">{{task.mode === 'instant' ? 'å³' : 'æˆª'}}</text>
                        </view>
                      </view>
                    </view>
                  </view>
                </block>
              </view>
            </view>
          </block>
          
          <!-- ç©ºçŠ¶æ€ -->
          <view wx:if="{{totalWeekTasks === 0}}" class="river-empty-state">
            <view class="river-empty-illustration">
              <view class="river-zen-circle"></view>
              <view class="river-zen-text">ğŸ“‹</view>
            </view>
            <text class="river-empty-main-text">æœ¬å‘¨æ— å¾…åŠäº‹é¡¹</text>
            <text class="river-empty-sub-text">äº«å—å®é™çš„å­¦ä¹ æ—¶å…‰</text>
          </view>
        </view>
      </view>
    </view>

    <!-- === æœˆè§†å›¾ (Event Horizon & Mood Mosaic) === -->
    <view wx:if="{{viewMode === 'month'}}" class="view-container month-view fade-in">
      
      <!-- å¿ƒæƒ…æ‰“å¡å¼¹çª— -->
      <view class="mood-checkin-modal" wx:if="{{monthView.showMoodCheckIn}}">
        <view class="mood-modal-backdrop" catchtap="closeMoodCheckIn"></view>
        <view class="mood-modal-content">
          <view class="mood-modal-header">
            <text class="mood-modal-title">æ˜¨å¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ</text>
            <text class="mood-modal-subtitle">è®°å½•å¿ƒæƒ…ï¼Œç»˜åˆ¶ä½ çš„æœˆåº¦é©¬èµ›å…‹</text>
          </view>
          <view class="mood-options">
            <view class="mood-option" wx:for="{{[ {mood: 'happy', emoji: 'ğŸ˜Š', label: 'å¼€å¿ƒ'}, {mood: 'productive', emoji: 'ğŸ’ª', label: 'å……å®'}, {mood: 'calm', emoji: 'ğŸ˜Œ', label: 'å¹³é™'}, {mood: 'excited', emoji: 'ğŸ‰', label: 'å…´å¥‹'}, {mood: 'tired', emoji: 'ğŸ˜´', label: 'ç–²æƒ«'}, {mood: 'anxious', emoji: 'ğŸ˜°', label: 'ç„¦è™‘'} ]}}" wx:key="mood" catchtap="saveMoodCheckIn" data-mood="{{item.mood}}">
              <view class="mood-emoji">{{item.emoji}}</view>
              <text class="mood-label">{{item.label}}</text>
            </view>
          </view>
          <view class="mood-modal-actions">
            <view class="mood-btn skip" catchtap="skipMoodCheckIn">è·³è¿‡</view>
          </view>
        </view>
      </view>

      <!-- 1. æœˆåº¦ç»Ÿè®¡å¡ç‰‡ -->
      <view class="month-stats-grid">
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthView.stats.totalEvents || 0}}</text>
          <text class="stat-label">é‡è¦äº‹ä»¶</text>
        </view>
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthView.stats.nearEvents || 0}}</text>
          <text class="stat-label">ä¸´è¿‘äº‹ä»¶</text>
        </view>
        <view class="stat-card glass-card highlight">
          <text class="stat-num">{{monthView.stats.moodDays || 0}}</text>
          <text class="stat-label">å¿ƒæƒ…æ‰“å¡</text>
        </view>
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthView.stats.currentStreak || 0}}</text>
          <text class="stat-label">è¿ç»­å¤©æ•°</text>
        </view>
      </view>

      <!-- æœˆåº¦å¾½ç«  -->
      <view class="monthly-badges" wx:if="{{monthView.monthlyBadges && monthView.monthlyBadges.length > 0}}">
        <view class="badges-title">
          <text class="badges-icon">ğŸ…</text>
          <text class="badges-text">æœ¬æœˆæˆå°±</text>
        </view>
        <view class="badges-container">
          <view class="badge-item" wx:for="{{monthView.monthlyBadges}}" wx:key="id">
            <view class="badge-icon" style="background: {{item.color}}20; color: {{item.color}};">{{item.icon}}</view>
            <view class="badge-info">
              <text class="badge-name">{{item.name}}</text>
              <text class="badge-desc">{{item.description}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 2. äº‹ä»¶è§†ç•Œ - å…³é”®èŠ‚ç‚¹å€’è®¡æ—¶ -->
      <view class="section-head mt-40">
        <text class="head-title">äº‹ä»¶è§†ç•Œ</text>
        <text class="head-sub">å…³é”®èŠ‚ç‚¹å€’è®¡æ—¶</text>
      </view>
      
      <view class="event-horizon-container">
        <!-- å€’è®¡æ—¶å²› -->
        <view class="countdown-island">
          <view class="island-title">å³å°†åˆ°æ¥çš„é‡è¦äº‹ä»¶</view>
          <view class="countdown-list">
            <block wx:for="{{monthView.eventHorizonEvents}}" wx:key="id">
              <view class="countdown-item {{item.eventHorizonType}}">
                <view class="countdown-days">
                  <text class="days-number">{{item.daysUntil}}</text>
                  <text class="days-label">å¤©</text>
                </view>
                <view class="countdown-info">
                  <text class="event-title">{{item.title}}</text>
                  <text class="event-type">{{item.eventHorizonType === 'exam' ? 'è€ƒè¯•' : item.eventHorizonType === 'deadline' ? 'æˆªæ­¢' : 'é‡è¦'}}</text>
                </view>
                <view class="event-horizon-indicator {{item.eventHorizonType}}"></view>
              </view>
            </block>
            <view wx:if="{{monthView.eventHorizonEvents.length === 0}}" class="no-events-tip">
              <text class="no-events-text">æœ¬æœˆæš‚æ— é‡è¦äº‹ä»¶</text>
              <text class="no-events-sub">äº«å—å®é™çš„æ—¶å…‰</text>
            </view>
          </view>
        </view>

        <!-- æœˆåº¦æ—¥å†ç½‘æ ¼ -->
        <view class="month-calendar-grid">
          <!-- æ˜ŸæœŸæ ‡é¢˜ -->
          <view class="calendar-weekdays">
            <view class="weekday" wx:for="{{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']}}" wx:key="*this">
              <text class="weekday-text">{{item}}</text>
            </view>
          </view>
          
          <!-- æ—¥æœŸæ ¼å­ -->
          <view class="calendar-days">
            <block wx:for="{{monthView.calendarGrid}}" wx:key="day">
              <view class="calendar-day {{item.isToday ? 'today' : ''}} {{item.isWeekend ? 'weekend' : ''}}" 
                    style="transform: scale({{1 - item.gravityDistortion * 0.1}}); opacity: {{0.7 + item.gravity * 0.3}};">
                
                <!-- æ—¥æœŸæ•°å­— -->
                <view class="day-number {{item.isToday ? 'today-number' : ''}}">{{item.day}}</view>
                
                <!-- å¿ƒæƒ…é©¬èµ›å…‹ -->
                <view class="mood-mosaic" wx:if="{{item.moodGlow}}" style="background: {{item.moodColor}}; opacity: 0.3;">
                  <view class="mood-glow" style="background: {{item.moodColor}};"></view>
                </view>
                
                <!-- äº‹ä»¶è§†ç•Œè¿çº¿ -->
                <block wx:if="{{item.hasEventHorizon}}" wx:for="{{item.eventHorizonLines}}" wx:for-item="line" wx:key="type">
                  <view class="event-horizon-line {{line.type}}" 
                        wx:if="{{line.connectToBottom}}"
                        style="height: {{200 + line.gravityStrength * 100}}rpx; opacity: {{0.6 + line.gravityStrength * 0.4}};">
                  </view>
                </block>
                
                <!-- äº‹ä»¶æŒ‡ç¤ºå™¨ -->
                <view class="event-indicators" wx:if="{{item.events.length > 0}}">
                  <view class="event-dot {{item.events[0].eventHorizonType}}" 
                        style="background: {{item.events[0].gravityStrength > 0.5 ? '#FF6B6B' : '#87A8A4'}};">
                  </view>
                  <view class="event-count" wx:if="{{item.events.length > 1}}">{{item.events.length}}</view>
                </view>
                
                <!-- å¼•åŠ›åœºæ‰­æ›²æ•ˆæœ -->
                <view class="gravity-field" wx:if="{{item.gravityDistortion > 0}}" 
                      style="border-radius: {{50 - item.gravityDistortion * 20}}%; border: 1px solid rgba(255, 107, 107, {{item.gravityDistortion * 0.3}});">
                </view>
              </view>
            </block>
          </view>
        </view>
      </view>

      <!-- 3. å¿ƒç»ªé©¬èµ›å…‹ç»Ÿè®¡ -->
      <view class="section-head mt-40">
        <text class="head-title">å¿ƒç»ªé©¬èµ›å…‹</text>
        <text class="head-sub">æœ¬æœˆæƒ…ç»ªåˆ†å¸ƒ</text>
      </view>
      
      <view class="mood-mosaic-stats">
        <view class="mood-score-card glass-card">
          <view class="score-circle">
            <text class="score-number">{{monthView.stats.monthMoodScore || 0}}</text>
            <text class="score-label">å¿ƒæƒ…æŒ‡æ•°</text>
          </view>
          <view class="score-details">
            <text class="score-desc">æœ¬æœˆå¹³å‡å¿ƒæƒ…çŠ¶æ€</text>
            <text class="score-days">{{monthView.stats.perfectMoodDays || 0}} å¤©é«˜èƒ½é‡</text>
          </view>
        </view>
        
        <view class="mood-distribution">
          <view class="mood-bar-item" wx:for="{{[ {mood: 'happy', emoji: 'ğŸ˜Š', color: '#FFD93D'}, {mood: 'productive', emoji: 'ğŸ’ª', color: '#6BCF7F'}, {mood: 'calm', emoji: 'ğŸ˜Œ', color: '#87CEEB'}, {mood: 'anxious', emoji: 'ğŸ˜°', color: '#95A5A6'} ]}}" wx:key="mood">
            <view class="mood-bar-emoji">{{item.emoji}}</view>
            <view class="mood-bar-track">
              <view class="mood-bar-fill" style="background: {{item.color}}; width: {{item.percentage || 20}}%;"></view>
            </view>
          </view>
        </view>
      </view>

    </view>

    <view class="spacer-bottom"></view>
  </scroll-view>

  <floating-action-button />

  <!-- è¯¾ç¨‹è¯¦æƒ…å¼¹çª— -->
  <view class="course-detail-modal" wx:if="{{showCourseDetail}}">
    <view class="modal-mask" catchtap="closeCourseDetail"></view>
    <view class="modal-content">
      <!-- è¯¾ç¨‹è‹±é›„åŒºåŸŸ -->
      <view class="course-hero" style="background: linear-gradient(135deg, {{selectedCourse.color}}20, {{selectedCourse.color}}10);">
        <view class="course-hero-content">
          <view class="course-color-badge" style="background: {{selectedCourse.color}};"></view>
          <text class="course-name">{{selectedCourse.name || 'æœªçŸ¥è¯¾ç¨‹'}}</text>
          <view class="course-time-badge">{{selectedCourse.time || 'æ—¶é—´æœªçŸ¥'}}</view>
        </view>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <view class="course-actions">
          <view class="action-btn edit-btn" catchtap="openCourseEditor">
            <view class="btn-icon">âœï¸</view>
            <text class="btn-text">ç¼–è¾‘</text>
          </view>
          <view class="action-btn delete-btn" catchtap="deleteCourse">
            <view class="btn-icon">ğŸ—‘ï¸</view>
            <text class="btn-text">åˆ é™¤</text>
          </view>
        </view>
      </view>
      
      <!-- è¯¾ç¨‹è¯¦ç»†ä¿¡æ¯ -->
      <view class="course-details">
        <view class="detail-section">
          <text class="section-title">ğŸ“š è¯¾ç¨‹ä¿¡æ¯</text>
          <view class="detail-grid">
            <view class="detail-item">
              <text class="detail-label">æ˜ŸæœŸ</text>
              <text class="detail-value">å‘¨{{['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][(selectedCourse.day || 1) - 1]}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">èŠ‚æ¬¡</text>
              <text class="detail-value">{{selectedCourse.start || 1}}-{{(selectedCourse.start || 1) + (selectedCourse.len || 1) - 1}}èŠ‚</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">æ—¶é•¿</text>
              <text class="detail-value">{{(selectedCourse.len || 1) * 45}}åˆ†é’Ÿ</text>
            </view>
            <view class="detail-item" wx:if="{{selectedCourse.teacher}}">
              <text class="detail-label">æ•™å¸ˆ</text>
              <text class="detail-value">{{selectedCourse.teacher}}</text>
            </view>
            <view class="detail-item" wx:if="{{selectedCourse.location}}">
              <text class="detail-label">æ•™å®¤</text>
              <text class="detail-value">{{selectedCourse.location}}</text>
            </view>
          </view>
        </view>

        <!-- ç›¸å…³ä»»åŠ¡ -->
        <view class="detail-section" wx:if="{{selectedCourseTasks.length > 0}}">
          <text class="section-title">ğŸ“‹ ç›¸å…³ä»»åŠ¡</text>
          <view class="task-list">
            <block wx:for="{{selectedCourseTasks}}" wx:key="id">
              <view class="task-card">
                <view class="task-type-indicator {{item.type}}">
                  <text class="task-icon">{{item.type === 'exam' ? 'ğŸ“' : 'ğŸ“š'}}</text>
                </view>
                <view class="task-content">
                  <text class="task-title">{{item.title}}</text>
                  <text class="task-deadline">{{item.deadline}}</text>
                </view>
                <view class="task-status {{item.completed ? 'completed' : ''}}">
                  <text class="status-text">{{item.completed ? 'å·²å®Œæˆ' : 'å¾…å®Œæˆ'}}</text>
                </view>
              </view>
            </block>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-tasks" wx:if="{{selectedCourseTasks.length === 0}}">
          <view class="empty-icon">ğŸ“</view>
          <text class="empty-text">æš‚æ— ç›¸å…³ä»»åŠ¡</text>
          <text class="empty-sub">å¯ä»¥ä¸ºæ­¤è¯¾ç¨‹æ·»åŠ ä½œä¸šæˆ–è€ƒè¯•å®‰æ’</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯¾ç¨‹ç¼–è¾‘å¼¹çª— -->
  <view class="course-editor-modal" wx:if="{{showCourseEditor}}">
    <view class="modal-mask" catchtap="closeCourseEditor"></view>
    <view class="editor-content">
      <view class="editor-header">
        <text class="editor-title">{{editingCourse.isNew ? 'æ·»åŠ è¯¾ç¨‹' : 'ç¼–è¾‘è¯¾ç¨‹'}}</text>
        <view class="close-btn" catchtap="closeCourseEditor">âœ•</view>
      </view>
      
      <view class="editor-body">
        <!-- è¯¾ç¨‹åç§° -->
        <view class="form-group">
          <text class="form-label">è¯¾ç¨‹åç§° *</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°" value="{{courseForm.name}}" 
                 data-field="name" bindinput="onCourseFormChange" />
        </view>

        <!-- æ•™å¸ˆå§“å -->
        <view class="form-group">
          <text class="form-label">æˆè¯¾æ•™å¸ˆ</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥æ•™å¸ˆå§“å" value="{{courseForm.teacher}}" 
                 data-field="teacher" bindinput="onCourseFormChange" />
        </view>

        <!-- ä¸Šè¯¾åœ°ç‚¹ -->
        <view class="form-group">
          <text class="form-label">ä¸Šè¯¾åœ°ç‚¹</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥ä¸Šè¯¾åœ°ç‚¹" value="{{courseForm.location}}" 
                 data-field="location" bindinput="onCourseFormChange" />
        </view>

        <!-- æ—¶é—´å®‰æ’ -->
        <view class="form-row">
          <view class="form-group flex-1">
            <text class="form-label">æ˜ŸæœŸ</text>
            <picker mode="selector" range="{{['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥']}}" 
                    value="{{courseForm.day - 1}}" data-field="day" bindchange="onCourseFormChange">
              <view class="picker-input">{{['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'][courseForm.day - 1]}}</view>
            </picker>
          </view>
          
          <view class="form-group flex-1">
            <text class="form-label">å¼€å§‹èŠ‚æ¬¡</text>
            <picker mode="selector" range="{{[1,2,3,4,5,6,7,8,9,10,11,12]}}" 
                    value="{{courseForm.start - 1}}" data-field="start" bindchange="onCourseFormChange">
              <view class="picker-input">ç¬¬{{courseForm.start}}èŠ‚</view>
            </picker>
          </view>
          
          <view class="form-group flex-1">
            <text class="form-label">è¯¾ç¨‹é•¿åº¦</text>
            <picker mode="selector" range="{{[1,2,3,4]}}" 
                    value="{{courseForm.len - 1}}" data-field="len" bindchange="onCourseFormChange">
              <view class="picker-input">{{courseForm.len}}èŠ‚è¯¾</view>
            </picker>
          </view>
        </view>

        <!-- é¢œè‰²é€‰æ‹© -->
        <view class="form-group">
          <text class="form-label">è¯¾ç¨‹é¢œè‰²</text>
          <view class="color-picker">
            <block wx:for="{{['#87A8A4', '#BCA0BC', '#E2C2A4', '#E08E79', '#9BB5CE', '#C9A5A0']}}" wx:key="*this">
              <view class="color-option {{courseForm.color === item ? 'selected' : ''}}" 
                    style="background: {{item}}" 
                    catchtap="selectCourseColor" 
                    data-color="{{item}}"></view>
            </block>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="editor-actions">
        <view class="action-btn cancel-btn" catchtap="closeCourseEditor">å–æ¶ˆ</view>
        <view class="action-btn save-btn" catchtap="saveCourse">ä¿å­˜</view>
      </view>
    </view>
  </view>

  <!-- å¾…åŠç¼–è¾‘å¼¹çª— -->
  <view class="task-editor-modal" wx:if="{{showTaskEditor}}">
    <view class="modal-mask" catchtap="closeTaskEditor"></view>
    <view class="editor-content task-editor-shell">
      <view class="editor-header">
        <text class="editor-title">{{editingTask ? 'ç¼–è¾‘å¾…åŠ' : 'æ–°å»ºå¾…åŠ'}}</text>
        <view class="close-btn" catchtap="closeTaskEditor">âœ•</view>
      </view>
      
      <scroll-view class="editor-body" scroll-y="true">
        <view class="task-mode-grid">
          <view class="mode-card {{taskForm.mode === 'persistent' ? 'active' : ''}}" data-mode="persistent" bindtap="switchTaskMode">
            <text class="mode-eyebrow">æŒç»­ç±»</text>
            <text class="mode-title">ä½œä¸š / é¡¹ç›®</text>
            <text class="mode-desc">æˆªæ­¢æ—¥å‰çš„æ¯ä¸€å¤©éƒ½ä¼šæ˜¾ç¤º</text>
            <view class="mode-chip">Deadline</view>
          </view>
          <view class="mode-card instant {{taskForm.mode === 'instant' ? 'active' : ''}}" data-mode="instant" bindtap="switchTaskMode">
            <text class="mode-eyebrow">ç¬æ—¶ç±»</text>
            <text class="mode-title">è€ƒè¯• / æ´»åŠ¨</text>
            <text class="mode-desc">åªåœ¨äº‹ä»¶å½“å¤©æé†’</text>
            <view class="mode-chip">Event Time</view>
          </view>
        </view>

        <view class="form-group">
          <text class="form-label">äº‹é¡¹æ ‡é¢˜ *</text>
          <input class="form-input" placeholder="ç»™å¾…åŠèµ·ä¸ªåå­—" value="{{taskForm.title}}" 
                 data-field="title" bindinput="onTaskFormChange" />
        </view>

        <view class="deadline-panel">
          <picker mode="date" value="{{taskForm.deadline_date}}" 
                  data-field="deadline_date" bindchange="onTaskFormChange">
            <view class="deadline-pill">
              <text class="pill-label">æ—¥æœŸ</text>
              <text class="pill-value">{{taskForm.deadline_date || 'é€‰æ‹©æ—¥æœŸ'}}</text>
            </view>
          </picker>
          <picker mode="time" value="{{taskForm.deadline_time}}" 
                  data-field="deadline_time" bindchange="onTaskFormChange"
                  wx:if="{{taskForm.mode === 'instant' || taskForm.has_specific_time}}">
            <view class="deadline-pill">
              <text class="pill-label">æ—¶é—´</text>
              <text class="pill-value">{{taskForm.deadline_time || 'é€‰æ‹©æ—¶é—´'}}</text>
            </view>
          </picker>
        </view>

        <view class="time-toggle-row" wx:if="{{taskForm.mode === 'persistent'}}">
          <text class="form-label subtle">éœ€è¦å…·ä½“æ—¶é—´æé†’ï¼Ÿ</text>
          <view class="toggle-switch {{taskForm.has_specific_time ? 'active' : ''}}" 
                catchtap="toggleSpecificTime">
            <view class="toggle-slider"></view>
          </view>
        </view>

        <view class="mode-hint" wx:if="{{taskForm.mode === 'persistent'}}">
          <text>æˆªæ­¢æ—¥å‰ï¼Œæ¯å¤©çš„å¾…åŠåˆ—è¡¨éƒ½ä¼šæ˜¾ç¤ºå®ƒã€‚</text>
        </view>
        <view class="mode-hint" wx:else>
          <text>äº‹ä»¶ä»…åœ¨æ‰€é€‰æ—¥æœŸå‡ºç°ï¼ŒåŠ¡å¿…å¡«å¥½å…·ä½“æ—¶é—´ã€‚</text>
        </view>

        <view class="form-group">
          <text class="form-label">ä»»åŠ¡æè¿°</text>
          <textarea class="form-textarea" placeholder="è¡¥å……ç»†èŠ‚ã€å‡†å¤‡äº‹é¡¹æˆ–é“¾æ¥..." value="{{taskForm.description}}" 
                    data-field="description" bindinput="onTaskFormChange" />
        </view>

        <!-- é‡è¦äº‹ä»¶è®¾ç½® -->
        <view class="form-group">
          <view class="important-event-section">
            <view class="important-event-header">
              <text class="form-label">è®¾ä¸ºé‡è¦äº‹ä»¶</text>
              <text class="form-subtitle">å°†åœ¨æœˆè§†å›¾çš„äº‹ä»¶è§†ç•Œä¸­æ˜¾ç¤º</text>
            </view>
            
            <view class="important-event-options">
              <view class="event-type-option {{taskForm.type === 'exam' ? 'active' : ''}}" 
                    data-type="exam" catchtap="selectEventType">
                <view class="event-type-icon">ğŸ“</view>
                <text class="event-type-name">è€ƒè¯•</text>
              </view>
              
              <view class="event-type-option {{taskForm.type === 'deadline' ? 'active' : ''}}" 
                    data-type="deadline" catchtap="selectEventType">
                <view class="event-type-icon">â°</view>
                <text class="event-type-name">æˆªæ­¢æ—¥æœŸ</text>
              </view>
              
              <view class="event-type-option {{taskForm.type === 'holiday' ? 'active' : ''}}" 
                    data-type="holiday" catchtap="selectEventType">
                <view class="event-type-icon">ğŸ‰</view>
                <text class="event-type-name">å‡æœŸ</text>
              </view>
              
              <view class="event-type-option {{taskForm.type === 'birthday' ? 'active' : ''}}" 
                    data-type="birthday" catchtap="selectEventType">
                <view class="event-type-icon">ğŸ‚</view>
                <text class="event-type-name">ç”Ÿæ—¥</text>
              </view>
              
              <view class="event-type-option {{taskForm.type === 'anniversary' ? 'active' : ''}}" 
                    data-type="anniversary" catchtap="selectEventType">
                <view class="event-type-icon">ğŸ’</view>
                <text class="event-type-name">çºªå¿µæ—¥</text>
              </view>
              
              <view class="event-type-option {{taskForm.urgent ? 'active' : ''}}" 
                    data-urgent="true" catchtap="toggleUrgent">
                <view class="event-type-icon">ğŸ”¥</view>
                <text class="event-type-name">ç´§æ€¥</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="editor-actions">
        <view class="action-btn cancel-btn" catchtap="closeTaskEditor">å–æ¶ˆ</view>
        <view class="action-btn delete-btn" wx:if="{{editingTask}}" catchtap="deleteTask">åˆ é™¤</view>
        <view class="action-btn save-btn" catchtap="saveTask">ä¿å­˜</view>
      </view>
    </view>
  </view>
</view>
