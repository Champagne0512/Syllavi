<view class="hub-page">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <custom-navbar title="Syllaby" subtitle="æ—¥ç¨‹ç®¡ç†">
    <view slot="right" class="profile-avatar" bindtap="goToProfile">
      <image wx:if="{{profile.avatar_url}}" src="{{profile.avatar_url}}" class="avatar-img"></image>
      <view wx:else class="avatar-placeholder">ğŸ‘¤</view>
    </view>
  </custom-navbar>

  <!-- è§†å›¾åˆ‡æ¢å™¨ & æ—¥æœŸæ§åˆ¶ -->
  <view class="header-controls">
    <view class="view-switch">
      <view class="chip {{viewMode === 'day' ? 'chip-active' : ''}}" bindtap="switchView" data-mode="day">æ—¥</view>
      <view class="chip {{viewMode === 'week' ? 'chip-active' : ''}}" bindtap="switchView" data-mode="week">å‘¨</view>
      <view class="chip {{viewMode === 'month' ? 'chip-active' : ''}}" bindtap="switchView" data-mode="month">æœˆ</view>
    </view>

    <view class="date-nav glass" wx:if="{{viewMode !== 'nothing'}}">
      <view class="nav-btn" bindtap="changeDate" data-direction="-1">
        <text class="arrow">â€¹</text>
      </view>
      <text class="date-display">{{currentDateText}}</text>
      <view class="nav-btn" bindtap="changeDate" data-direction="1">
        <text class="arrow">â€º</text>
      </view>
    </view>
  </view>

  <scroll-view class="zen-scroll" scroll-y="true" enable-flex>
    
    <!-- === æ—¥è§†å›¾ (Day) === -->
    <view wx:if="{{viewMode === 'day'}}" class="view-container day-view fade-in">
      <!-- ä»Šæ—¥è¯¾ç¨‹ -->
      <view class="section-head">
        <text class="head-title">ä»Šæ—¥è¯¾ç¨‹</text>
        <text class="head-sub">{{todayCourses.length}} èŠ‚</text>
      </view>
      
      <view class="course-timeline">
        <block wx:for="{{todayCourses}}" wx:key="id">
          <view class="timeline-item">
            <view class="time-col">
              <text class="start-time">{{item.time.split('-')[0]}}</text>
              <view class="time-dot" style="background: {{item.color}}"></view>
            </view>
            <view class="course-card glass-card" style="border-left: 8rpx solid {{item.color}}">
              <text class="card-title">{{item.name}}</text>
              <text class="card-sub">{{item.location}}</text>
            </view>
          </view>
        </block>
        <view wx:if="{{todayCourses.length === 0}}" class="empty-tip">
          <text>ä»Šå¤©æ²¡æœ‰è¯¾ï¼Œå»å›¾ä¹¦é¦†å­¦ä¹ å§</text>
        </view>
      </view>

      <!-- ä»Šæ—¥å¾…åŠ -->
      <view class="section-head mt-40">
        <text class="head-title">ä»Šæ—¥å¾…åŠ</text>
        <view class="head-sub">{{todayTasks.length}} é¡¹</view>
      </view>

      <view class="task-stack">
        <block wx:for="{{todayTasks}}" wx:key="id">
          <view class="task-row glass-card {{item.completed ? 'done' : ''}}">
            <view class="check-circle {{item.completed ? 'checked' : ''}}"></view>
            <view class="task-info">
              <text class="task-text">{{item.title}}</text>
              <text class="task-meta" style="color: {{item.accent}}">{{item.course}} Â· {{item.deadline}}</text>
            </view>
          </view>
        </block>
        <view wx:if="{{todayTasks.length === 0}}" class="empty-tip">
          <text>ä»Šæ—¥ä»»åŠ¡å·²æ¸…ç©º</text>
        </view>
      </view>
    </view>

    <!-- === å‘¨è§†å›¾ (Week) === -->
    <view wx:if="{{viewMode === 'week'}}" class="view-container week-view fade-in">
      <!-- ç®€æ˜“è¯¾è¡¨ç½‘æ ¼ -->
      <view class="week-grid-container">
        <view class="week-header-row">
          <view class="corner-box"></view>
          <block wx:for="{{weekDays}}" wx:key="date">
            <view class="day-col-head {{item.isToday ? 'today-head' : ''}}">
              <text class="day-name">å‘¨{{item.name}}</text>
              <text class="day-num">{{item.date}}</text>
            </view>
          </block>
        </view>

        <view class="week-body">
          <!-- ä¾§è¾¹æ—¶é—´è½´ -->
          <view class="time-sidebar">
            <block wx:for="{{[1,2,3,4,5,6,7,8,9,10,11,12]}}" wx:key="*this">
              <view class="sidebar-slot">{{item}}</view>
            </block>
          </view>
          
          <!-- è¯¾ç¨‹æ¸²æŸ“åŒº -->
          <view class="course-matrix">
             <block wx:for="{{weekDays}}" wx:key="date" wx:for-item="day" wx:for-index="dIdx">
                <!-- æ¯ä¸€åˆ— -->
                <view class="day-column-bg"></view>
             </block>
             
             <!-- ç»å¯¹å®šä½æ¸²æŸ“è¯¾ç¨‹ (éå† slot æ•°æ®) -->
             <block wx:for="{{timeSlots}}" wx:key="time" wx:for-item="slot">
                <block wx:for="{{slot.courses}}" wx:key="id" wx:for-item="course">
                  <!-- è®¡ç®—ä½ç½®: left = (day-1)*100/7 %, top = (start-1)*itemHeight -->
                  <view class="grid-course-item" 
                        style="left: {{(course.day - 1) * 14.28}}%; top: {{(course.start - 1) * 100}}rpx; height: {{course.len * 100}}rpx; background: {{course.color}};"
                        bindtap="openCourse" data-id="{{course.id}}">
                    <text class="grid-text">{{course.name}}</text>
                    <text class="grid-loc">{{course.location}}</text>
                  </view>
                </block>
             </block>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨ï¼šæœ¬å‘¨ä»»åŠ¡æ¦‚è§ˆ -->
      <view class="section-head mt-40">
        <text class="head-title">æœ¬å‘¨ä»»åŠ¡åˆ†å¸ƒ</text>
        <text class="head-sub">{{totalWeekTasks}} é¡¹</text>
      </view>
      <scroll-view scroll-x class="week-task-scroll" enable-flex>
        <block wx:for="{{weekTasksByDay}}" wx:key="date">
          <view class="week-task-card glass-card" wx:if="{{item.tasks.length > 0}}">
            <text class="wt-day">å‘¨{{item.label}}</text>
            <block wx:for="{{item.tasks}}" wx:key="id" wx:for-item="t">
               <view class="wt-chip {{t.type}}">{{t.title}}</view>
            </block>
          </view>
        </block>
        <view wx:if="{{hasNoWeekTasks}}" class="empty-tip inline">æœ¬å‘¨æ— ä»»åŠ¡</view>
      </scroll-view>
    </view>

    <!-- === æœˆè§†å›¾ (Month / Dashboard) === -->
    <view wx:if="{{viewMode === 'month'}}" class="view-container month-view fade-in">
      
      <!-- 1. æœˆåº¦ç»Ÿè®¡å¡ç‰‡ -->
      <view class="stats-grid">
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthStats.totalTasks || 0}}</text>
          <text class="stat-label">æ€»å¾…åŠ</text>
        </view>
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthStats.completedTasks || 0}}</text>
          <text class="stat-label">å·²å®Œæˆ</text>
        </view>
        <view class="stat-card glass-card highlight">
          <text class="stat-num">{{monthStats.exams || 0}}</text>
          <text class="stat-label">è€ƒè¯•</text>
        </view>
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthStats.busiestDay || '-'}}</text>
          <text class="stat-label">æœ€å¿™ç¢Œ</text>
        </view>
      </view>

      <!-- 2. ä»»åŠ¡çƒ­åŠ›å›¾ -->
      <view class="section-head mt-40">
        <text class="head-title">èƒ½é‡åˆ†å¸ƒ</text>
        <text class="head-sub">æœ¬æœˆä»»åŠ¡å¯†åº¦</text>
      </view>
      <view class="heatmap-container glass-card">
        <view class="heatmap-grid">
          <block wx:for="{{monthHeatmap}}" wx:key="day">
            <view class="heat-cell {{item.level}}">
              <text wx:if="{{item.count > 0}}" class="heat-num">{{item.day}}</text>
            </view>
          </block>
        </view>
        <view class="heatmap-legend">
          <text>Less</text>
          <view class="legend-dots">
            <view class="dot l0"></view>
            <view class="dot l1"></view>
            <view class="dot l2"></view>
            <view class="dot l3"></view>
          </view>
          <text>More</text>
        </view>
      </view>

      <!-- 3. è¿‘æœŸé‡è¦æ—¥ç¨‹ -->
      <view class="section-head mt-40">
        <text class="head-title">å³å°†åˆ°æ¥</text>
        <text class="head-sub">{{upcomingTasks.length}} é¡¹</text>
      </view>
      <view class="upcoming-list">
        <block wx:for="{{upcomingTasks}}" wx:key="id">
          <view class="upcoming-item glass-card">
            <view class="up-date">
              <text class="up-day">{{item.deadline.split('.')[1]}}</text>
              <text class="up-mon">{{item.deadline.split('.')[0]}}æœˆ</text>
            </view>
            <view class="up-info">
              <text class="up-title">{{item.title}}</text>
              <text class="up-sub {{item.urgent ? 'urgent-text' : ''}}">{{item.course}}</text>
            </view>
            <view class="up-tag" style="background: {{item.accent}}"></view>
          </view>
        </block>
        <view wx:if="{{upcomingTasks.length === 0}}" class="empty-tip">æœªæ¥7å¤©æš‚æ— æ€¥è¿«ä»»åŠ¡</view>
      </view>

    </view>

    <view class="spacer-bottom"></view>
  </scroll-view>

  <floating-action-button />
</view>