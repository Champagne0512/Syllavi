<view class="hub-page">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <custom-navbar title="Syllaby" subtitle="æ—¥ç¨‹ç®¡ç†">
    <view slot="right" class="profile-avatar" bindtap="goToProfile">
      <image wx:if="{{profile.avatar_url}}" src="{{profile.avatar_url}}" class="avatar-img"></image>
      <view wx:else class="avatar-placeholder">ğŸ‘¤</view>
    </view>
  </custom-navbar>

  <!-- è§†å›¾åˆ‡æ¢å™¨ & æ—¥æœŸæ§åˆ¶ -->
  <view class="header-controls">
    <view class="view-switch">
      <view class="chip {{viewMode === 'day' ? 'chip-active' : ''}}" bindtap="switchView" data-mode="day">æ—¥</view>
      <view class="chip {{viewMode === 'week' ? 'chip-active' : ''}}" bindtap="switchView" data-mode="week">å‘¨</view>
      <view class="chip {{viewMode === 'month' ? 'chip-active' : ''}}" bindtap="switchView" data-mode="month">æœˆ</view>
    </view>

    <view class="date-nav glass" wx:if="{{viewMode !== 'nothing'}}">
      <view class="nav-btn" bindtap="changeDate" data-direction="-1">
        <text class="arrow">â€¹</text>
      </view>
      <text class="date-display">{{currentDateText}}</text>
      <view class="nav-btn" bindtap="changeDate" data-direction="1">
        <text class="arrow">â€º</text>
      </view>
    </view>
  </view>

  <scroll-view class="zen-scroll" scroll-y="true" enable-flex>
    
    <!-- === æ—¥è§†å›¾ (Day) === -->
    <view wx:if="{{viewMode === 'day'}}" class="view-container day-view fade-in">
      <!-- ä»Šæ—¥è¯¾ç¨‹ -->
      <view class="section-head">
        <text class="head-title">ä»Šæ—¥è¯¾ç¨‹</text>
        <text class="head-sub">{{todayCourses.length}} èŠ‚</text>
      </view>
      
      <view class="course-timeline">
        <block wx:for="{{todayCourses}}" wx:key="id">
          <view class="timeline-item">
            <view class="time-col">
              <text class="start-time">{{item.time.split('-')[0]}}</text>
              <view class="time-dot" style="background: {{item.color}}"></view>
            </view>
            <view class="course-card glass-card" style="border-left: 8rpx solid {{item.color}}">
              <text class="card-title">{{item.name}}</text>
              <text class="card-sub">{{item.location}}</text>
            </view>
          </view>
        </block>
        <view wx:if="{{todayCourses.length === 0}}" class="empty-tip">
          <text>ä»Šå¤©æ²¡æœ‰è¯¾ï¼Œå»å›¾ä¹¦é¦†å­¦ä¹ å§</text>
        </view>
      </view>

      <!-- ä»Šæ—¥å¾…åŠ -->
      <view class="section-head mt-40">
        <text class="head-title">ä»Šæ—¥å¾…åŠ</text>
        <view class="head-sub">{{todayTasks.length}} é¡¹</view>
      </view>

      <view class="task-stack">
        <block wx:for="{{todayTasks}}" wx:key="id">
          <view class="task-row glass-card {{item.completed ? 'done' : ''}}">
            <view class="check-circle {{item.completed ? 'checked' : ''}}"></view>
            <view class="task-info">
              <text class="task-text">{{item.title}}</text>
              <text class="task-meta" style="color: {{item.accent}}">{{item.course}} Â· {{item.deadline}}</text>
            </view>
          </view>
        </block>
        <view wx:if="{{todayTasks.length === 0}}" class="empty-tip">
          <text>ä»Šæ—¥ä»»åŠ¡å·²æ¸…ç©º</text>
        </view>
      </view>
    </view>

    <!-- === å‘¨è§†å›¾ (Week) === -->
  <view wx:if="{{viewMode === 'week'}}" class="view-container week-view fade-in">
      <!-- è¯¾ç¨‹ç®¡ç†æ ‡é¢˜ -->
      <view class="week-header-actions">
        <view class="section-title-group">
          <text class="head-title">è¯¾ç¨‹è¡¨</text>
          <text class="head-sub">{{totalWeekCourses || 5}} é—¨è¯¾ç¨‹</text>
        </view>
        <view class="add-course-btn" bindtap="addCourse">
          <text class="add-icon">ï¼‹</text>
          <text class="add-text">æ·»åŠ è¯¾ç¨‹</text>
        </view>
      </view>

      <!-- ç®€æ˜“è¯¾è¡¨ç½‘æ ¼ -->
      <view class="week-grid-container">
        <view class="week-header-row">
          <view class="corner-box"></view>
          <block wx:for="{{weekDays}}" wx:key="fullDate">
            <view class="day-col-head {{item.isToday ? 'today-head' : ''}} {{selectedDay === item.dateKey ? 'selected-head' : ''}}" 
                  bindtap="selectDay" data-date="{{item.dateKey}}">
              <text class="day-name">å‘¨{{item.name}}</text>
              <text class="day-num">{{item.date}}</text>
              <view class="day-indicator {{item.isToday ? 'today-indicator' : ''}} {{selectedDay === item.dateKey ? 'selected-indicator' : ''}}"></view>
            </view>
          </block>
        </view>

        <view class="week-body">
          <!-- ä¾§è¾¹æ—¶é—´è½´ -->
          <view class="time-sidebar">
            <block wx:for="{{[1,2,3,4,5,6,7,8,9,10,11,12]}}" wx:key="*this">
              <view class="sidebar-slot">{{item}}</view>
            </block>
          </view>
          
          <!-- è¯¾ç¨‹æ¸²æŸ“åŒº -->
          <view class="course-matrix">
             <block wx:for="{{weekDays}}" wx:key="fullDate" wx:for-item="day" wx:for-index="dIdx">
                <!-- æ¯ä¸€åˆ— -->
                <view class="day-column-bg"></view>
             </block>
             
             <!-- ç»å¯¹å®šä½æ¸²æŸ“è¯¾ç¨‹ (éå† slot æ•°æ®) -->
             <block wx:for="{{timeSlots}}" wx:key="time" wx:for-item="slot">
                <block wx:for="{{slot.courses}}" wx:key="id" wx:for-item="course">
                  <!-- è®¡ç®—ä½ç½®: left = (day-1)*100/7 %, top = (start-1)*itemHeight -->
                  <view class="grid-course-item" 
                        style="left: {{(course.day - 1) * 14.28}}%; top: {{(course.start - 1) * 100}}rpx; height: {{course.len * 100}}rpx; background: {{course.color}};"
                        bindtap="openCourse" data-id="{{course.id}}">
                    <text class="grid-text">{{course.name}}</text>
                    <text class="grid-loc">{{course.location}}</text>
                  </view>
                </block>
             </block>
          </view>
        </view>
      </view>

      <!-- é€‰ä¸­æ—¥æœŸçš„è¯¾ç¨‹è¯¦æƒ… -->
      <view wx:if="{{selectedDay}}" class="selected-day-section glass-card fade-in">
        <view class="selected-day-header">
          <text class="selected-day-title">
            {{selectedDayCourses.length > 0 ? 'ğŸ“š ' : 'ğŸ’¤ '}}
            {{selectedDayText}}çš„è¯¾ç¨‹
          </text>
          <text class="selected-day-count">{{selectedDayCourses.length}} èŠ‚è¯¾</text>
        </view>
        
        <view class="selected-day-courses">
          <block wx:for="{{selectedDayCourses}}" wx:key="id">
            <view class="selected-course-card" style="border-left-color: {{item.color}};">
              <view class="course-time-badge">{{item.time}}</view>
              <text class="course-name">{{item.name}}</text>
              <text class="course-location">{{item.location}}</text>
            </view>
          </block>
          <view wx:if="{{selectedDayCourses.length === 0}}" class="no-courses-tip">
            <text>è¿™ä¸€å¤©æ²¡æœ‰è¯¾ç¨‹å®‰æ’</text>
            <text class="tip-sub">å¯ä»¥å¥½å¥½ä¼‘æ¯æˆ–å®‰æ’è‡ªä¹ </text>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨ï¼šæœ¬å‘¨ä»»åŠ¡æ²³æµ -->
      <view class="section-head mt-40">
        <text class="head-title">æœ¬å‘¨ä»»åŠ¡æ²³æµ</text>
        <text class="head-sub">{{totalWeekTasks}} é¡¹</text>
      </view>
      <view class="week-tasks-enhanced">
        <!-- å¼¥æ•£èƒŒæ™¯è£…é¥° -->
        <view class="tasks-background-decoration">
          <view class="blob blob-1"></view>
          <view class="blob blob-2"></view>
          <view class="blob blob-3"></view>
        </view>
        
        <!-- ä»»åŠ¡æ²³æµæ ‡é¢˜ -->
        <view class="river-title-section">
          <view class="title-visual-element">
            <view class="breathing-dot"></view>
            <text class="river-title">æœ¬å‘¨ä»»åŠ¡æµ</text>
            <view class="title-underline"></view>
          </view>
          
          <view class="river-stats-row">
            <view class="river-stat-item">
              <text class="river-stat-number">{{totalWeekTasks}}</text>
              <text class="river-stat-label">é¡¹ä»»åŠ¡</text>
            </view>
          </view>
        </view>

        <!-- ä»»åŠ¡æ²³æµå†…å®¹ -->
        <view class="river-content-area">
          <block wx:for="{{weekTasksByDay}}" wx:key="dateKey" wx:for-item="day">
            <view class="river-day-container {{day.isToday ? 'today-highlight' : ''}}" wx:if="{{day.tasks && day.tasks.length > 0}}">
              <!-- æ—¥æœŸæŒ‡ç¤ºå™¨ -->
              <view class="river-date-indicator">
                <view class="river-date-circle {{day.isToday ? 'today' : ''}}">
                  <text class="river-date-text">{{day.date}}</text>
                </view>
                <text class="river-date-label">å‘¨{{day.label}}</text>
                <view class="river-task-count">{{day.tasks.length}}</view>
              </view>
              
              <!-- ä»»åŠ¡æµ -->
              <view class="river-task-flow">
                <block wx:for="{{day.tasks}}" wx:key="id" wx:for-item="task">
                  <view class="river-task-item {{task.completed ? 'completed-flow' : ''}}" 
                        data-task="{{task}}">
                    <!-- è¿æ¥çº¿ -->
                    <view class="river-flow-line"></view>
                    
                    <!-- ä»»åŠ¡èŠ‚ç‚¹ -->
                    <view class="river-task-node">
                      <view class="river-node-core {{task.type === 'exam' ? 'urgent-node' : ''}}">
                        <view class="river-node-inner"></view>
                      </view>
                      
                      <!-- ä»»åŠ¡å¡ç‰‡ -->
                      <view class="river-task-bubble {{task.type === 'exam' ? 'exam' : ''}}">
                        <view class="river-bubble-content">
                          <text class="river-bubble-title">{{task.title}}</text>
                          <text class="river-bubble-subtitle">{{task.time}}</text>
                        </view>
                        <view class="river-bubble-type-indicator">
                          <text class="river-type-text">{{task.type === 'exam' ? 'è€ƒ' : 'ä¸š'}}</text>
                        </view>
                      </view>
                    </view>
                  </view>
                </block>
              </view>
            </view>
          </block>
          
          <!-- ç©ºçŠ¶æ€ -->
          <view wx:if="{{totalWeekTasks === 0}}" class="river-empty-state">
            <view class="river-empty-illustration">
              <view class="river-zen-circle"></view>
              <view class="river-zen-text">ğŸ“‹</view>
            </view>
            <text class="river-empty-main-text">æœ¬å‘¨æ— å¾…åŠäº‹é¡¹</text>
            <text class="river-empty-sub-text">äº«å—å®é™çš„å­¦ä¹ æ—¶å…‰</text>
          </view>
        </view>
      </view>
    </view>

    <!-- === æœˆè§†å›¾ (Month / Dashboard) === -->
    <view wx:if="{{viewMode === 'month'}}" class="view-container month-view fade-in">
      
      <!-- 1. æœˆåº¦ç»Ÿè®¡å¡ç‰‡ -->
      <view class="stats-grid">
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthStats.totalTasks || 0}}</text>
          <text class="stat-label">æ€»å¾…åŠ</text>
        </view>
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthStats.completedTasks || 0}}</text>
          <text class="stat-label">å·²å®Œæˆ</text>
        </view>
        <view class="stat-card glass-card highlight">
          <text class="stat-num">{{monthStats.exams || 0}}</text>
          <text class="stat-label">è€ƒè¯•</text>
        </view>
        <view class="stat-card glass-card">
          <text class="stat-num">{{monthStats.busiestDay || '-'}}</text>
          <text class="stat-label">æœ€å¿™ç¢Œ</text>
        </view>
      </view>

      <!-- 2. ä»»åŠ¡çƒ­åŠ›å›¾ -->
      <view class="section-head mt-40">
        <text class="head-title">èƒ½é‡åˆ†å¸ƒ</text>
        <text class="head-sub">æœ¬æœˆä»»åŠ¡å¯†åº¦</text>
      </view>
      <view class="heatmap-container glass-card">
        <view class="heatmap-grid">
          <block wx:for="{{monthHeatmap}}" wx:key="day">
            <view class="heat-cell {{item.level}}">
              <text wx:if="{{item.count > 0}}" class="heat-num">{{item.day}}</text>
            </view>
          </block>
        </view>
        <view class="heatmap-legend">
          <text>Less</text>
          <view class="legend-dots">
            <view class="dot l0"></view>
            <view class="dot l1"></view>
            <view class="dot l2"></view>
            <view class="dot l3"></view>
          </view>
          <text>More</text>
        </view>
      </view>

      <!-- 3. è¿‘æœŸé‡è¦æ—¥ç¨‹ -->
      <view class="section-head mt-40">
        <text class="head-title">å³å°†åˆ°æ¥</text>
        <text class="head-sub">{{upcomingTasks.length}} é¡¹</text>
      </view>
      <view class="upcoming-list">
        <block wx:for="{{upcomingTasks}}" wx:key="id">
          <view class="upcoming-item glass-card">
            <view class="up-date">
              <text class="up-day">{{item.deadline.split('.')[1]}}</text>
              <text class="up-mon">{{item.deadline.split('.')[0]}}æœˆ</text>
            </view>
            <view class="up-info">
              <text class="up-title">{{item.title}}</text>
              <text class="up-sub {{item.urgent ? 'urgent-text' : ''}}">{{item.course}}</text>
            </view>
            <view class="up-tag" style="background: {{item.accent}}"></view>
          </view>
        </block>
        <view wx:if="{{upcomingTasks.length === 0}}" class="empty-tip">æœªæ¥7å¤©æš‚æ— æ€¥è¿«ä»»åŠ¡</view>
      </view>

    </view>

    <view class="spacer-bottom"></view>
  </scroll-view>

  <floating-action-button />

  <!-- è¯¾ç¨‹è¯¦æƒ…å¼¹çª— -->
  <view class="course-detail-modal" wx:if="{{showCourseDetail}}">
    <view class="modal-mask" catchtap="closeCourseDetail"></view>
    <view class="modal-content">
      <!-- è¯¾ç¨‹å¤´éƒ¨ -->
      <view class="course-hero" style="background: linear-gradient(135deg, {{selectedCourse.color}}20, {{selectedCourse.color}}10);">
        <view class="course-hero-content">
          <view class="course-color-badge" style="background: {{selectedCourse.color}};"></view>
          <text class="course-name">{{selectedCourse.name || 'æœªçŸ¥è¯¾ç¨‹'}}</text>
          <text class="course-location">{{selectedCourse.location || 'æœªè®¾ç½®åœ°ç‚¹'}}</text>
          <view class="course-time-badge">{{selectedCourse.time || 'æ—¶é—´æœªçŸ¥'}}</view>
        </view>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <view class="course-actions">
          <view class="action-btn edit-btn" catchtap="openCourseEditor">
            <view class="btn-icon">âœï¸</view>
            <text class="btn-text">ç¼–è¾‘</text>
          </view>
          <view class="action-btn delete-btn" catchtap="deleteCourse">
            <view class="btn-icon">ğŸ—‘ï¸</view>
            <text class="btn-text">åˆ é™¤</text>
          </view>
        </view>
      </view>
      
      <!-- è¯¾ç¨‹è¯¦ç»†ä¿¡æ¯ -->
      <view class="course-details">
        <view class="detail-section">
          <text class="section-title">ğŸ“š è¯¾ç¨‹ä¿¡æ¯</text>
          <view class="detail-grid">
            <view class="detail-item">
              <text class="detail-label">æ˜ŸæœŸ</text>
              <text class="detail-value">å‘¨{{['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][(selectedCourse.day || 1) - 1]}}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">èŠ‚æ¬¡</text>
              <text class="detail-value">{{selectedCourse.start || 1}}-{{(selectedCourse.start || 1) + (selectedCourse.len || 1) - 1}}èŠ‚</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">æ—¶é•¿</text>
              <text class="detail-value">{{(selectedCourse.len || 1) * 45}}åˆ†é’Ÿ</text>
            </view>
            <view class="detail-item" wx:if="{{selectedCourse.teacher}}">
              <text class="detail-label">æ•™å¸ˆ</text>
              <text class="detail-value">{{selectedCourse.teacher}}</text>
            </view>
          </view>
        </view>

        <!-- ç›¸å…³ä»»åŠ¡ -->
        <view class="detail-section" wx:if="{{selectedCourseTasks.length > 0}}">
          <text class="section-title">ğŸ“‹ ç›¸å…³ä»»åŠ¡</text>
          <view class="task-list">
            <block wx:for="{{selectedCourseTasks}}" wx:key="id">
              <view class="task-card">
                <view class="task-type-indicator {{item.type}}">
                  <text class="task-icon">{{item.type === 'exam' ? 'ğŸ“' : 'ğŸ“š'}}</text>
                </view>
                <view class="task-content">
                  <text class="task-title">{{item.title}}</text>
                  <text class="task-deadline">{{item.deadline}}</text>
                </view>
                <view class="task-status {{item.completed ? 'completed' : ''}}">
                  <text class="status-text">{{item.completed ? 'å·²å®Œæˆ' : 'å¾…å®Œæˆ'}}</text>
                </view>
              </view>
            </block>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-tasks" wx:if="{{selectedCourseTasks.length === 0}}">
          <view class="empty-icon">ğŸ“</view>
          <text class="empty-text">æš‚æ— ç›¸å…³ä»»åŠ¡</text>
          <text class="empty-sub">å¯ä»¥ä¸ºæ­¤è¯¾ç¨‹æ·»åŠ ä½œä¸šæˆ–è€ƒè¯•å®‰æ’</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¯¾ç¨‹ç¼–è¾‘å¼¹çª— -->
  <view class="course-editor-modal" wx:if="{{showCourseEditor}}">
    <view class="modal-mask" catchtap="closeCourseEditor"></view>
    <view class="editor-content">
      <view class="editor-header">
        <text class="editor-title">{{editingCourse.isNew ? 'æ·»åŠ è¯¾ç¨‹' : 'ç¼–è¾‘è¯¾ç¨‹'}}</text>
        <view class="close-btn" catchtap="closeCourseEditor">âœ•</view>
      </view>
      
      <view class="editor-body">
        <!-- è¯¾ç¨‹åç§° -->
        <view class="form-group">
          <text class="form-label">è¯¾ç¨‹åç§° *</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°" value="{{courseForm.name}}" 
                 data-field="name" bindinput="onCourseFormChange" />
        </view>

        <!-- æ•™å¸ˆå§“å -->
        <view class="form-group">
          <text class="form-label">æˆè¯¾æ•™å¸ˆ</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥æ•™å¸ˆå§“å" value="{{courseForm.teacher}}" 
                 data-field="teacher" bindinput="onCourseFormChange" />
        </view>

        <!-- ä¸Šè¯¾åœ°ç‚¹ -->
        <view class="form-group">
          <text class="form-label">ä¸Šè¯¾åœ°ç‚¹</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥ä¸Šè¯¾åœ°ç‚¹" value="{{courseForm.location}}" 
                 data-field="location" bindinput="onCourseFormChange" />
        </view>

        <!-- æ—¶é—´å®‰æ’ -->
        <view class="form-row">
          <view class="form-group flex-1">
            <text class="form-label">æ˜ŸæœŸ</text>
            <picker mode="selector" range="{{['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥']}}" 
                    value="{{courseForm.day - 1}}" data-field="day" bindchange="onCourseFormChange">
              <view class="picker-input">{{['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'][courseForm.day - 1]}}</view>
            </picker>
          </view>
          
          <view class="form-group flex-1">
            <text class="form-label">å¼€å§‹èŠ‚æ¬¡</text>
            <picker mode="selector" range="{{[1,2,3,4,5,6,7,8,9,10,11,12]}}" 
                    value="{{courseForm.start - 1}}" data-field="start" bindchange="onCourseFormChange">
              <view class="picker-input">ç¬¬{{courseForm.start}}èŠ‚</view>
            </picker>
          </view>
          
          <view class="form-group flex-1">
            <text class="form-label">è¯¾ç¨‹é•¿åº¦</text>
            <picker mode="selector" range="{{[1,2,3,4]}}" 
                    value="{{courseForm.len - 1}}" data-field="len" bindchange="onCourseFormChange">
              <view class="picker-input">{{courseForm.len}}èŠ‚è¯¾</view>
            </picker>
          </view>
        </view>

        <!-- é¢œè‰²é€‰æ‹© -->
        <view class="form-group">
          <text class="form-label">è¯¾ç¨‹é¢œè‰²</text>
          <view class="color-picker">
            <block wx:for="{{['#87A8A4', '#BCA0BC', '#E2C2A4', '#E08E79', '#9BB5CE', '#C9A5A0']}}" wx:key="*this">
              <view class="color-option {{courseForm.color === item ? 'selected' : ''}}" 
                    style="background: {{item}}" 
                    catchtap="selectCourseColor" 
                    data-color="{{item}}"></view>
            </block>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="editor-actions">
        <view class="action-btn cancel-btn" catchtap="closeCourseEditor">å–æ¶ˆ</view>
        <view class="action-btn save-btn" catchtap="saveCourse">ä¿å­˜</view>
      </view>
    </view>
  </view>
</view>
