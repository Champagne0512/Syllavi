<view class="tasks-page">
  <custom-navbar title="Syllaby" subtitle="待办 / 考试" />

  <view class="tab-row">
    <view class="tab-switch glass">
      <view class="tab {{activeTab === 'homework' ? 'active' : ''}}"
        data-tab="homework"
        bindtap="switchTab">
        Homework
      </view>
      <view class="tab {{activeTab === 'exam' ? 'active' : ''}}"
        data-tab="exam"
        bindtap="switchTab">
        Exams
      </view>
    </view>
    <button class="add-btn" bindtap="openCreate">
      ＋ 新建
    </button>
  </view>

  <scroll-view class="zen-scroll" scroll-y="true">
    <block wx:for="{{tasks}}" wx:key="id">
      <view wx:if="{{item.type === activeTab}}" class="task-card card"
        data-id="{{item.id}}"
        bindtap="openEdit">
        <view class="task-info">
          <text class="title">{{item.title}}</text>
          <text class="muted">Due {{item.deadline}}</text>
          <text class="mono badge">{{item.course}}</text>
        </view>
        <view class="progress-shell">
          <view class="donut" style="--accent: {{item.accent}}; --progress: {{item.progress}};"></view>
          <text class="mono pct">{{item.progressPct}}%</text>
        </view>
        <button class="ghost-btn" data-id="{{item.id}}" catchtap="markDone">
          {{item.completed ? '已完成' : '标记完成'}}
        </button>
      </view>
    </block>

    <view class="widget card">
      <view class="section-head">
        <text>桌面小组件预览</text>
        <text class="muted">2x2 & 4x2</text>
      </view>
      <view class="widget-grid">
        <view class="widget-card">
          <text class="muted">Next</text>
          <text class="mono big">AI 工程 · 16:00</text>
          <text class="muted small">Focus Flow ready</text>
        </view>
        <view class="widget-card large">
          <view>
            <text class="muted">Deadline</text>
            <text class="mono big">设计报告 23:59</text>
          </view>
          <view class="linear-bar">
            <view class="linear-fill"></view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <view wx:if="{{editorVisible}}" class="editor-mask" bindtap="closeEditor">
    <view class="editor-sheet card" catchtap="noop">
      <view class="section-head">
        <text>{{editingTask ? '编辑任务' : '新建任务'}}</text>
        <text class="muted mono">{{form.type === 'exam' ? 'Exam' : 'Homework'}}</text>
      </view>
      <view class="field">
        <text class="label">类型</text>
        <view class="chip-row">
          <view class="chip {{form.type === 'homework' ? 'chip-active' : ''}}"
            data-type="homework"
            bindtap="changeType">
            作业
          </view>
          <view class="chip {{form.type === 'exam' ? 'chip-active' : ''}}"
            data-type="exam"
            bindtap="changeType">
            考试
          </view>
        </view>
      </view>
      <view class="field">
        <text class="label">标题</text>
        <input class="input" placeholder="例如：数据库设计作业" value="{{form.title}}" bindinput="onTitleChange" />
      </view>
      <view class="field">
        <text class="label">截止时间</text>
        <picker mode="date" value="{{form.date}}" bindchange="onDateChange">
          <view class="picker-row">
            <text>{{form.date || '选择日期'}}</text>
          </view>
        </picker>
        <picker mode="time" value="{{form.time}}" bindchange="onTimeChange">
          <view class="picker-row">
            <text>{{form.time || '选择时间'}}</text>
          </view>
        </picker>
      </view>
      <view class="field">
        <text class="label">备注</text>
        <textarea class="textarea" placeholder="补充说明（可选）" value="{{form.description}}" bindinput="onDescChange" />
      </view>
      <view class="editor-actions">
        <button class="ghost-btn" bindtap="closeEditor">取消</button>
        <button class="primary-btn" loading="{{saving}}" bindtap="submitTask">
          保存
        </button>
      </view>
      <button wx:if="{{editingTask}}" class="danger-btn" bindtap="deleteCurrent">
        删除任务
      </button>
    </view>
  </view>
</view>
