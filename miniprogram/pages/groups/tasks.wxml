<!-- pages/groups/tasks.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="nav-bar">
    <view class="nav-back" bindtap="goBack">
      <text class="nav-icon">â†</text>
    </view>
    <view class="nav-title">ä»»åŠ¡ç®¡ç†</view>
    <view class="nav-placeholder"></view>
  </view>
  
  <!-- ä»»åŠ¡ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-card" wx:if="{{taskStats}}">
    <view class="stats-title">ä»»åŠ¡æ¦‚è§ˆ</view>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-value">{{taskStats.total}}</text>
        <text class="stat-label">æ€»ä»»åŠ¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-value completed">{{taskStats.completed}}</text>
        <text class="stat-label">å·²å®Œæˆ</text>
      </view>
      <view class="stat-item">
        <text class="stat-value pending">{{taskStats.pending}}</text>
        <text class="stat-label">è¿›è¡Œä¸­</text>
      </view>
      <view class="stat-item">
        <text class="stat-value overdue">{{taskStats.overdue}}</text>
        <text class="stat-label">å·²è¿‡æœŸ</text>
      </view>
    </view>
  </view>

  <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
  <view class="quick-actions">
    <button wx:if="{{userRole === 'leader' || userRole === 'deputy_leader'}}" class="action-btn primary" bindtap="showCreateTask">
      <text class="btn-icon">+</text>
      <text>åˆ›å»ºä»»åŠ¡</text>
    </button>
    <button wx:if="{{userRole === 'leader' || userRole === 'deputy_leader'}}" class="action-btn secondary" bindtap="quickCreateTasks">
      <text class="btn-icon">âš¡</text>
      <text>å¿«é€Ÿåˆ›å»ºç¤ºä¾‹</text>
    </button>
    <button class="action-btn secondary" bindtap="refreshTasks">
      <text class="btn-icon">âŸ³</text>
      <text>åˆ·æ–°</text>
    </button>
  </view>

  <!-- ä»»åŠ¡åˆ—è¡¨ -->
  <view class="tasks-section">
    <view class="section-header">
      <text class="section-title">å°ç»„ä»»åŠ¡</text>
      <text class="task-count">{{tasks.length}} ä¸ªä»»åŠ¡</text>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading}}">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <view class="tasks-list" wx:if="{{!loading}}">
      <view class="empty-state" wx:if="{{tasks.length === 0}}">
        <text class="empty-icon">ğŸ“‹</text>
        <text class="empty-text">æš‚æ— å°ç»„ä»»åŠ¡</text>
        <text class="empty-tip">ç‚¹å‡»ä¸Šæ–¹"åˆ›å»ºä»»åŠ¡"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡</text>
      </view>

      <view class="task-item" wx:for="{{tasks}}" wx:key="id" bindtap="viewTaskDetail" data-id="{{item.id}}">
        <view class="task-header">
          <view class="task-title-section">
            <text class="task-title {{item.isCompleted ? 'completed' : ''}}">{{item.title}}</text>
            <view class="task-tags">
              <text class="tag important" wx:if="{{item.isImportant}}">é‡ç‚¹</text>
              <text class="tag urgent" wx:if="{{item.urgent}}">ç´§æ€¥</text>
              <text class="tag type" wx:if="{{item.displayType}}">{{item.displayType === 'exam' ? 'è€ƒè¯•' : item.displayType === 'homework' ? 'ä½œä¸š' : item.displayType === 'group' ? 'å°ç»„' : 'å…¶ä»–'}}</text>
              <text class="tag mode">{{item.displayMode === 'instant' ? 'å³æ—¶' : 'æŒç»­'}}</text>
            </view>
            <view class="task-source">
              <text class="source-text">åˆ›å»ºäº: {{item.created_at}}</text>
            </view>
          </view>
          <view class="task-status {{item.status}}">
            <text>{{item.isCompleted ? 'å·²å®Œæˆ' : item.isOverdue ? 'å·²è¿‡æœŸ' : 'è¿›è¡Œä¸­'}}</text>
          </view>
        </view>

        <view class="task-content">
          <text class="task-description" wx:if="{{item.description}}">{{item.description}}</text>
          
          <view class="task-meta">
            <view class="meta-item" wx:if="{{item.deadline}}">
              <text class="meta-icon">â°</text>
              <text class="meta-text {{item.isOverdue ? 'overdue' : ''}}">{{item.formattedDeadline}}</text>
            </view>
            <view class="meta-item">
              <text class="meta-icon">âš™ï¸</text>
              <text class="meta-text">æ¨¡å¼: {{item.displayMode === 'instant' ? 'å³æ—¶ä»»åŠ¡' : 'æŒç»­å¾…åŠ'}}</text>
            </view>
            <view class="meta-item">
              <text class="meta-icon">ğŸ‘¥</text>
              <text class="meta-text">çŠ¶æ€: {{item.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}}{{item.urgent ? ' Â· ç´§æ€¥' : ''}}</text>
            </view>
          </view>
        </view>

        <view class="task-actions" wx:if="{{userRole === 'leader' || userRole === 'deputy_leader' || item.status !== 'completed'}}">
          <button class="btn-action complete" wx:if="{{!item.isCompleted}}" 
                  bindtap="toggleTaskStatus" data-id="{{item.id}}" data-index="{{index}}" data-status="{{item.status}}" catchtap>
            {{item.status === 'completed' ? 'æ ‡è®°æœªå®Œæˆ' : 'æ ‡è®°å®Œæˆ'}}
          </button>
          <button class="btn-action delete" wx:if="{{userRole === 'leader' || userRole === 'deputy_leader'}}" 
                  bindtap="deleteTask" data-id="{{item.id}}" catchtap>
            åˆ é™¤
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ›å»ºä»»åŠ¡æ¨¡æ€æ¡† -->
  <view class="modal-overlay" wx:if="{{showCreateModal}}" bindtap="hideCreateTask">
    <view class="modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">åˆ›å»ºå°ç»„ä»»åŠ¡</text>
        <text class="modal-close" bindtap="hideCreateTask">Ã—</text>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <label class="form-label">ä»»åŠ¡æ ‡é¢˜</label>
          <input class="form-input" placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜"
                 value="{{taskForm.title}}" bindinput="onTitleInput" />
        </view>

        <view class="form-group">
          <label class="form-label">ä»»åŠ¡æè¿°</label>
          <textarea class="form-textarea" placeholder="æè¿°ä»»åŠ¡èƒŒæ™¯æˆ–è¦æ±‚"
                    value="{{taskForm.description}}" bindinput="onDescriptionInput" />
        </view>

        <view class="form-group">
          <label class="form-label">ä»»åŠ¡æ¨¡å¼</label>
          <view class="mode-switch">
            <view class="mode-item {{taskForm.mode === 'persistent' ? 'active' : ''}}" data-mode="persistent" bindtap="switchTaskMode">æŒç»­å¾…åŠ</view>
            <view class="mode-item {{taskForm.mode === 'instant' ? 'active' : ''}}" data-mode="instant" bindtap="switchTaskMode">å³æ—¶ä»»åŠ¡</view>
          </view>
        </view>

        <view class="form-group">
          <label class="form-label">ä»»åŠ¡ç±»å‹</label>
          <view class="type-chips">
            <view class="chip {{taskForm.type === 'homework' ? 'active' : ''}}" data-type="homework" bindtap="selectTaskType">ä½œä¸š</view>
            <view class="chip {{taskForm.type === 'exam' ? 'active' : ''}}" data-type="exam" bindtap="selectTaskType">è€ƒè¯•</view>
            <view class="chip {{taskForm.type === 'group' ? 'active' : ''}}" data-type="group" bindtap="selectTaskType">å°ç»„ä»»åŠ¡</view>
            <view class="chip {{taskForm.type === 'other' ? 'active' : ''}}" data-type="other" bindtap="selectTaskType">å…¶ä»–</view>
          </view>
        </view>

        <view class="form-group toggles">
          <view class="toggle-item" bindtap="toggleImportant">
            <view class="toggle-dot {{taskForm.isImportant ? 'on' : ''}}"></view>
            <text>é‡ç‚¹ä»»åŠ¡</text>
          </view>
          <view class="toggle-item" bindtap="toggleUrgent">
            <view class="toggle-dot alert {{taskForm.urgent ? 'on' : ''}}"></view>
            <text>ç´§æ€¥æé†’</text>
          </view>
        </view>

        <view class="form-group">
          <label class="form-label">æˆªæ­¢æ—¥æœŸ</label>
          <picker mode="date" value="{{taskForm.deadline_date}}" bindchange="onDeadlineDateChange">
            <view class="date-picker">
              <text class="date-text" wx:if="{{taskForm.deadline_date}}">{{taskForm.deadline_date}}</text>
              <text class="date-placeholder" wx:else>é€‰æ‹©æ—¥æœŸ</text>
            </view>
          </picker>
        </view>

        <view class="form-group specific-time">
          <view class="specific-head">
            <text class="form-label">å…·ä½“æ—¶é—´</text>
            <switch checked="{{taskForm.has_specific_time}}" bindchange="toggleSpecificTime" color="#87A8A4" />
          </view>
          <picker mode="time" value="{{taskForm.deadline_time || '08:00'}}" bindchange="onDeadlineTimeChange" wx:if="{{taskForm.has_specific_time}}">
            <view class="date-picker">
              <text class="date-text" wx:if="{{taskForm.deadline_time}}">{{taskForm.deadline_time}}</text>
              <text class="date-placeholder" wx:else>é€‰æ‹©æ—¶é—´</text>
            </view>
          </picker>
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideCreateTask">å–æ¶ˆ</button>
        <button class="btn-confirm" bindtap="createTask">åˆ›å»ºä»»åŠ¡</button>
      </view>
    </view>
  </view>
</view>
