<!--pages/groups/detail.wxml-->
<view class="zen-container">
  <!-- 弥散背景装饰 -->
  <view class="floating-field">
    <view class="mesh-orb orb-a"></view>
    <view class="mesh-orb orb-b"></view>
    <view class="mesh-orb orb-c"></view>
    <view class="mesh-orb orb-d"></view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="zen-loading">
    <view class="breathing-dot"></view>
    <text class="loading-text">正在加载小组信息...</text>
  </view>

  <!-- 小组详情 -->
  <view wx:if="{{!loading && groupInfo !== null}}" class="zen-group-detail">
    <!-- 玻璃导航栏 -->
    <view class="zen-navbar">
      <view class="nav-back" bindtap="goBack">
        <text class="back-icon">←</text>
      </view>
      <view class="nav-title">小组详情</view>
      <view class="nav-actions">
        <view class="nav-action" bindtap="shareGroup">
          <text class="action-text">分享</text>
        </view>
      </view>
    </view>

    <!-- 小组头部卡片 -->
    <view class="zen-group-header">
      <view class="header-glow"></view>
      <view class="header-content">
        <view class="group-avatar-section">
          <image class="group-avatar" src="{{groupInfo.avatar_url || '/static/icons/group-empty.svg'}}" binderror="handleAvatarError"></image>
          <view class="status-indicator {{groupInfo.is_public ? 'public' : 'private'}}"></view>
        </view>
        <view class="group-info">
          <view class="group-name-row">
            <text class="group-name">{{groupInfo.name || groupInfo.group_name}}</text>
            <view class="visibility-pill {{groupInfo.is_public ? 'public' : 'private'}}">
              {{groupInfo.is_public ? '公开小组' : '私密小组'}}
            </view>
          </view>
          <view class="group-meta">
            <view class="meta-item">
              <text class="meta-label">成员</text>
              <text class="meta-text">{{groupInfo.member_count || 0}} / {{groupInfo.max_members || 0}}</text>
            </view>
            <view class="meta-item">
              <text class="meta-label">创建者</text>
              <text class="meta-text">{{creatorName || '未知'}}</text>
            </view>
          </view>
          <view class="group-code-row">
            <view class="code-box">
              <text class="code-label">小组码</text>
              <text class="code-value">{{groupInfo.group_code}}</text>
            </view>
            <button class="copy-btn" bindtap="copyGroupCode">复制</button>
          </view>
        </view>
      </view>
    </view>

    <!-- 用户角色卡片 -->
    <view wx:if="{{isMember && userRole}}" class="zen-role-card">
      <view class="role-glow"></view>
      <view class="role-content">
        <view class="role-dot {{userRole}}"></view>
        <view class="role-info">
          <text class="role-title">{{userRole === 'leader' ? '组长' : userRole === 'deputy_leader' ? '副组长' : '组员'}}</text>
          <text class="role-desc">{{userRole === 'leader' ? '管理小组的所有事务' : userRole === 'deputy_leader' ? '协助组长管理小组' : '参与小组学习活动'}}</text>
        </view>
      </view>
    </view>

    <view wx:if="{{isMember}}" class="zen-summary-card">
      <view class="summary-item">
        <text class="summary-value">{{taskStats.total || 0}}</text>
        <text class="summary-label">总任务</text>
      </view>
      <view class="summary-item">
        <text class="summary-value">{{taskStats.completed || 0}}</text>
        <text class="summary-label">已完成</text>
      </view>
      <view class="summary-item">
        <text class="summary-value">{{taskStats.total > 0 ? Math.round((taskStats.completed / taskStats.total) * 100) : 0}}%</text>
        <text class="summary-label">完成率</text>
      </view>
    </view>

    <!-- 快捷操作 -->
    <view class="zen-quick-actions">
      <button wx:if="{{!isMember && groupInfo}}" class="zen-action-btn primary" bindtap="joinGroup">
        <text class="action-text">申请加入</text>
      </button>
      <button wx:if="{{isMember && (userRole === 'leader' || userRole === 'deputy_leader')}}" class="zen-action-btn secondary" bindtap="inviteMember">
        <text class="action-text">邀请成员</text>
      </button>
      <button wx:if="{{isMember && (userRole === 'leader' || userRole === 'deputy_leader')}}" class="zen-action-btn secondary" bindtap="batchAssignTasks">
        <text class="action-text">安排任务</text>
      </button>
    </view>

    <!-- 导航标签 -->
    <view class="zen-tabs">
      <view
        class="zen-tab {{currentTab === 'info' ? 'active' : ''}}"
        data-tab="info"
        bindtap="switchTab"
      >
        <view class="tab-indicator"></view>
        <text class="tab-text">小组信息</text>
      </view>
      <view
        wx:if="{{isMember}}"
        class="zen-tab {{currentTab === 'members' ? 'active' : ''}}"
        data-tab="members"
        bindtap="switchTab"
      >
        <view class="tab-indicator"></view>
        <text class="tab-text">成员列表</text>
      </view>
      <view
        wx:if="{{isMember}}"
        class="zen-tab {{currentTab === 'tasks' ? 'active' : ''}}"
        data-tab="tasks"
        bindtap="switchTab"
      >
        <view class="tab-indicator"></view>
        <text class="tab-text">小组任务</text>
      </view>
    </view>

    <!-- 内容区域 -->
    <view class="zen-content">
      <!-- 小组信息 -->
      <view wx:if="{{currentTab === 'info'}}" class="zen-section">
        <view class="zen-card">
          <view class="card-header">
            <text class="card-title">小组描述</text>
          </view>
          <view class="card-content">
            <text class="description-text">{{groupInfo.description || '暂无描述，这是一个充满学习活力的小组'}}</text>
          </view>
        </view>

        <view class="zen-card">
          <view class="card-header">
            <text class="card-title">基本信息</text>
          </view>
          <view class="info-grid">
            <view class="info-item">
              <view class="info-content">
                <text class="info-label">创建时间</text>
                <text class="info-value">{{groupInfo.created_at}}</text>
              </view>
            </view>
            <view class="info-item">
              <view class="info-content">
                <text class="info-label">成员规模</text>
                <text class="info-value">{{groupInfo.member_count}} / {{groupInfo.max_members}}人</text>
              </view>
            </view>
            <view class="info-item">
              <view class="info-content">
                <text class="info-label">小组类型</text>
                <text class="info-value">{{groupInfo.is_public ? '公开小组' : '私密小组'}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 成员列表 -->
      <view wx:if="{{currentTab === 'members' && isMember}}" class="zen-section">
        <view class="zen-members-grid">
          <view class="zen-member-card" wx:for="{{members}}" wx:key="id">
            <view class="member-avatar">
              <image src="{{item.avatar_url || '/static/icons/group-empty.png'}}" class="member-image"></image>
              <view class="member-status {{item.role}}"></view>
            </view>
            <view class="member-info">
              <text class="member-name">{{item.nickname || item.username || '成员 ' + (index + 1)}}</text>
              <view class="member-role {{item.role}}">
                <text class="role-text">{{item.role === 'leader' ? '组长' : item.role === 'deputy_leader' ? '副组长' : '组员'}}</text>
              </view>
              <text class="join-time">加入于 {{item.joined_at}}</text>
            </view>
          </view>
        </view>

        <view class="zen-more-actions">
          <button class="zen-link-btn" bindtap="viewMembers">
            <text class="link-text">查看完整成员管理</text>
            <text class="link-arrow">→</text>
          </button>
        </view>
      </view>

      <!-- 小组任务 -->
      <view wx:if="{{currentTab === 'tasks' && isMember}}" class="zen-section">
        <view class="task-list-header">
          <text class="task-list-title">全部任务</text>
          <button wx:if="{{userRole === 'leader' || userRole === 'deputy_leader'}}" class="task-manage-btn" bindtap="openTaskManager">
            管理任务
          </button>
        </view>

        <view class="zen-tasks">
          <view wx:if="{{tasks.length === 0}}" class="zen-empty">
            <text class="empty-title">暂无任务</text>
            <text class="empty-desc">组长还没有安排任务</text>
          </view>

          <view
            class="zen-task-card {{item.status === 'completed' ? 'completed' : ''}}"
            wx:for="{{tasks}}"
            wx:key="id"
            data-id="{{item.id}}"
          >
            <view class="task-status">
              <text class="status-dot {{item.status === 'completed' ? 'completed' : ''}}"></text>
            </view>
            <view class="task-content">
              <view class="task-header">
                <text class="task-title">{{item.title}}</text>
                <view class="task-badges">
                  <text wx:if="{{item.isMyTask}}" class="task-badge my">我的任务</text>
                  <text wx:if="{{item.isCreator}}" class="task-badge creator">我创建</text>
                </view>
              </view>
              <text class="task-description">{{item.description}}</text>
              <view class="task-meta">
                <text wx:if="{{item.deadline}}" class="task-deadline">截止：{{item.deadline}}</text>
                <text class="task-created">创建：{{item.created_at}}</text>
              </view>
            </view>
            <view class="task-action">
              <button
                wx:if="{{item.isMyTask || userRole === 'leader' || userRole === 'deputy_leader'}}"
                class="zen-task-btn {{item.status === 'completed' ? 'undo' : 'complete'}}"
                data-id="{{item.id}}"
                bindtap="toggleTaskStatus"
              >
                <text class="btn-text">{{item.status === 'completed' ? '撤销完成' : '标记完成'}}</text>
              </button>
              <button
                wx:if="{{userRole === 'leader' || userRole === 'deputy_leader'}}"
                class="zen-task-btn plain"
                data-id="{{item.id}}"
                bindtap="editTask"
              >
                <text class="btn-text">编辑</text>
              </button>
            </view>
          </view>
        </view>

      </view>
    </view>

    <!-- 底部操作 -->
    <view wx:if="{{isMember}}" class="zen-bottom-actions">
      <button wx:if="{{userRole === 'leader'}}" class="zen-danger-btn" bindtap="disbandGroup">
        <text class="btn-text">解散小组</text>
      </button>
      <button class="zen-secondary-btn" bindtap="leaveGroup">
        <text class="btn-text">退出小组</text>
      </button>
    </view>
  </view>

  <!-- 底部安全区域 -->
  <view class="safe-bottom"></view>
</view>
