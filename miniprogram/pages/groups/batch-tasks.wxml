<!--pages/groups/batch-tasks.wxml-->
<view class="container">
  <view wx:if="{{loading}}" class="loading">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <view wx:else class="content">
    <view class="header-card glass">
      <text class="header-title">æ–°å»ºã€Œ{{groupInfo.name}}ã€çš„å°ç»„ä»»åŠ¡</text>
      <button class="ghost-btn" bindtap="fillExampleTask">å¡«å……ç¤ºä¾‹</button>
    </view>

    <scroll-view scroll-y class="form-scroll">
      <view class="card glass">
        <text class="card-title">ä»»åŠ¡ç±»å‹</text>
        <view class="mode-grid">
          <view class="mode-card {{taskForm.mode === 'persistent' ? 'active' : ''}}" data-mode="persistent" bindtap="switchTaskMode">
            <text class="mode-eyebrow">æŒç»­ç±»</text>
            <text class="mode-name">ä½œä¸š / é¡¹ç›®</text>
            <text class="mode-desc">æˆªæ­¢æ—¥å‰æ¯å¤©éƒ½æ˜¾ç¤º</text>
          </view>
          <view class="mode-card instant {{taskForm.mode === 'instant' ? 'active' : ''}}" data-mode="instant" bindtap="switchTaskMode">
            <text class="mode-eyebrow">ç¬æ—¶ç±»</text>
            <text class="mode-name">è€ƒè¯• / æ´»åŠ¨</text>
            <text class="mode-desc">åªåœ¨äº‹ä»¶å½“å¤©æé†’</text>
          </view>
        </view>
      </view>

      <view class="card glass">
        <view class="form-field">
          <text class="form-label">ä»»åŠ¡æ ‡é¢˜ *</text>
          <input class="form-input" placeholder="ä¾‹å¦‚ï¼šæäº¤é˜¶æ®µæ€§æŠ¥å‘Š" value="{{taskForm.title}}" data-field="title" bindinput="onInputChange" />
        </view>

        <view class="form-field">
          <text class="form-label">ä»»åŠ¡æè¿°</text>
          <textarea class="form-textarea" placeholder="è¡¥å……èƒŒæ™¯ã€æäº¤æ–¹å¼æˆ–å‚è€ƒé“¾æ¥..." value="{{taskForm.description}}" data-field="description" bindinput="onInputChange" />
        </view>

        <view class="deadline-row">
          <picker mode="date" value="{{taskForm.deadline_date}}" data-field="deadline_date" bindchange="onDateChange">
            <view class="deadline-pill">
              <text class="pill-label">æ—¥æœŸ</text>
              <text class="pill-value">{{taskForm.deadline_date || 'é€‰æ‹©æ—¥æœŸ'}}</text>
            </view>
          </picker>
          <picker mode="time" value="{{taskForm.deadline_time}}" bindchange="onTimeChange" wx:if="{{taskForm.mode === 'instant' || taskForm.has_specific_time}}">
            <view class="deadline-pill">
              <text class="pill-label">æ—¶é—´</text>
              <text class="pill-value">{{taskForm.deadline_time || 'é€‰æ‹©æ—¶é—´'}}</text>
            </view>
          </picker>
        </view>

        <view class="time-toggle" wx:if="{{taskForm.mode === 'persistent'}}">
          <text class="toggle-label">éœ€è¦å…·ä½“æ—¶é—´æé†’ï¼Ÿ</text>
          <view class="toggle-switch {{taskForm.has_specific_time ? 'active' : ''}}" bindtap="toggleSpecificTime">
            <view class="toggle-dot"></view>
          </view>
        </view>
      </view>

      <view class="card glass">
        <view class="card-header">
          <text class="card-title">é‡è¦äº‹ä»¶</text>
          <text class="card-subtitle">å¯è§†åŒ–åˆ°è¯¾ç¨‹ä¸å¾…åŠè§†å›¾</text>
        </view>
        <view class="event-grid">
          <view class="event-chip {{taskForm.type === item.key ? 'active' : ''}}" wx:for="{{eventOptions}}" wx:key="key" data-type="{{item.key}}" bindtap="selectEventType">
            <text class="chip-icon">{{item.icon}}</text>
            <text class="chip-label">{{item.label}}</text>
          </view>
          <view class="event-chip urgent {{taskForm.urgent ? 'active' : ''}}" bindtap="toggleUrgent">
            <text class="chip-icon">ğŸ”¥</text>
            <text class="chip-label">ç´§æ€¥äº‹ä»¶</text>
          </view>
        </view>
      </view>

      <view class="card glass">
        <view class="assign-row">
          <view>
            <text class="card-title">åˆ†é…æ–¹å¼</text>
            <text class="card-subtitle">é»˜è®¤å‘é€ç»™æ‰€æœ‰æˆå‘˜</text>
          </view>
          <switch checked="{{taskForm.assignToAll}}" bindchange="onAssignToAllChange" color="#87A8A4" />
        </view>

        <view wx:if="{{!taskForm.assignToAll}}">
          <text class="section-hint">å·²é€‰æ‹© {{taskForm.selectedMembers.length}} / {{members.length}}</text>
          <view class="member-grid">
            <view class="member-chip {{item.selected ? 'selected' : ''}}" wx:for="{{members}}" wx:key="id" data-index="{{index}}" bindtap="onMemberSelect">
              <text class="member-name">{{item.nickname}}</text>
              <text class="member-role">{{item.role === 'leader' ? 'ç»„é•¿' : item.role === 'deputy_leader' ? 'å‰¯ç»„é•¿' : 'æˆå‘˜'}}</text>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>

    <view class="footer">
      <view class="stats">
        <view class="stat">
          <text class="stat-value">{{members.length}}</text>
          <text class="stat-label">å°ç»„æˆå‘˜</text>
        </view>
        <view class="stat">
          <text class="stat-value">{{taskForm.assignToAll ? members.length : taskForm.selectedMembers.length}}</text>
          <text class="stat-label">å°†æ”¶åˆ°ä»»åŠ¡</text>
        </view>
      </view>
      <button class="primary-btn" bindtap="createBatchTasks" loading="{{submitting}}" disabled="{{submitting}}">
        {{submitting ? 'åˆ›å»ºä¸­...' : 'å‘å¸ƒä»»åŠ¡'}}
      </button>
    </view>
  </view>
</view>
