# 异步AI识别功能部署说明

## 修复内容

### 1. 云函数改造（cloudfunctions/deepseekAI/index.js）
- **异步模式**：云函数现在立即返回任务ID，不等待AI处理完成
- **后台处理**：AI识别在后台运行，不受3秒超时限制
- **状态检查**：支持检查任务状态（pending/processing/completed/failed）
- **内存存储**：任务状态存储在内存中（生产环境建议使用数据库）

### 2. 前端改造（pages/deepseek-ai/index.js）
- **任务轮询**：每秒检查一次任务状态
- **进度显示**：显示识别进度（0-100%）
- **错误处理**：处理超时和失败情况
- **自动保存**：识别完成后自动保存到数据库

### 3. 兼容性更新（pages/ai-import/index.js）
- **支持异步模式**：ai-import页面现在也支持新的异步AI识别
- **轮询逻辑**：添加了与deepseek-ai页面相同的轮询机制
- **错误处理**：改进了错误处理和超时处理

### 4. 工具函数更新（utils/supabase.js）
- **parseImageWithAI**：支持新的异步响应格式
- **向后兼容**：同时支持旧的同步响应格式

## 部署步骤

### 第一步：部署云函数
1. 打开微信开发者工具
2. 点击"云开发"按钮
3. 在云函数列表中找到 `deepseekAI`
4. 右键点击，选择"上传并部署：云端安装依赖"
5. 等待部署完成（约1-2分钟）

### 第二步：测试AI识别
1. 在开发者工具中点击"编译"
2. 进入"AI智能识别"页面
3. 选择一张课程表或待办事项图片
4. 等待识别结果（通常3-10秒）

### 第三步：验证功能
- ✅ 图片上传成功（无RLS错误）
- ✅ 任务创建成功（立即返回任务ID）
- ✅ 进度条正常显示（0-100%）
- ✅ 识别结果显示正常
- ✅ 结果自动保存到数据库

## 技术细节

### 异步流程
```
1. 用户选择图片
   ↓
2. 上传图片到Supabase存储
   ↓
3. 调用云函数创建任务（< 1秒）
   ↓
4. 云函数立即返回：{taskId: "xxx", status: "pending"}
   ↓
5. 前端开始轮询（每秒检查一次）
   ↓
6. 云函数后台调用DeepSeek API（5-10秒）
   ↓
7. 识别完成，更新任务状态
   ↓
8. 前端轮询到completed状态
   ↓
9. 显示结果并保存到数据库
```

### 任务状态
- **pending**: 任务已创建，等待处理
- **processing**: AI正在识别中
- **completed**: 识别完成，包含结果数据
- **failed**: 识别失败，包含错误信息

### 超时处理
- 前端最多轮询30次（约30秒）
- 超过30秒显示"AI识别超时"错误
- 云函数API调用超时设置为10秒

## 故障排除

### 问题1：云函数部署失败
**解决方案**：
- 检查 `cloudfunctions/deepseekAI/package.json` 是否存在
- 确保 `axios` 依赖已安装：`npm install`
- 重新部署云函数

### 问题2：图片上传403错误
**解决方案**：
- 检查Supabase存储桶RLS策略
- 确保用户已登录且有有效token
- 检查 `uploadToStorage` 函数参数

### 问题3：任务状态一直pending
**解决方案**：
- 检查云函数日志，确认后台处理是否启动
- 确认DeepSeek API密钥是否有效
- 检查网络连接是否正常

### 问题4：识别结果不准确
**解决方案**：
- 确保图片清晰、文字可见
- 尝试不同的识别模式（auto/course/task）
- 调整 `max_tokens` 参数增加细节

## 性能优化建议

### 生产环境改进
1. **使用数据库存储任务状态**：替换内存存储（Map）
2. **添加任务过期清理**：自动清理超过24小时的任务
3. **实现WebSocket推送**：替代轮询，减少请求次数
4. **添加缓存机制**：缓存相同图片的识别结果

### 成本优化
1. **限制图片大小**：上传前压缩图片
2. **设置任务超时**：避免长时间占用资源
3. **批量处理**：支持一次识别多张图片
4. **使用CDN**：加速图片加载速度

## 监控和日志

### 云函数日志
在微信开发者工具的云开发控制台查看：
- 任务创建日志
- AI API调用日志
- 错误和异常信息

### 前端日志
在小程序控制台查看：
- 图片上传进度
- 任务状态变化
- 识别结果数据

## 安全注意事项

1. **API密钥保护**：DeepSeek API密钥存储在云函数环境变量中
2. **用户认证**：确保用户登录后才能使用AI识别
3. **数据验证**：验证上传的图片格式和大小
4. **访问控制**：设置Supabase表的RLS策略

## 后续功能

- [ ] 支持更多识别类型（笔记、书籍、公式等）
- [ ] 添加识别结果编辑功能
- [ ] 实现批量图片识别
- [ ] 添加识别历史记录
- [ ] 支持多语言识别
- [ ] 集成其他AI服务（OpenAI、Claude等）
